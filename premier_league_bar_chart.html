
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Premier League Club Financials</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" href="https://use.typekit.net/xxs6huv.css">
  <style>
    body {
      background-color: #000000;
      color: white;
      font-family: 'aglet-sans', sans-serif;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #000000;
    }
    .controls-container { 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      margin-bottom: 30px; 
      gap: 20px; 
    }
    .control-group {
      background-color: rgba(5, 212, 190, 0.1);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid rgba(5, 212, 190, 0.3);
    }
    label { 
      font-size: 1rem; 
      margin-right: 10px; 
      color: #05D4BE; 
    }
    select {
      font-size: 1rem;
      padding: 8px 15px;
      background-color: #121212;
      color: white;
      border: 1px solid #05D4BE;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'aglet-sans', sans-serif;
    }
    select:hover { background-color: #1D3B48; }
    .charts-container { display: flex; flex-direction: column; gap: 20px; }
    .chart-wrapper {
      background-color: rgba(5, 212, 190, 0.05);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(5, 212, 190, 0.2);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .metrics-cards {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .metric-card {
      background: linear-gradient(135deg, rgba(5, 212, 190, 0.2), rgba(95, 132, 251, 0.2));
      border-radius: 8px;
      padding: 15px;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(5, 212, 190, 0.3);
      text-align: center;
    }
    .metric-value { font-size: 2rem; font-weight: bold; margin: 10px 0; color: #05D4BE; }
    .metric-title { font-size: 1rem; color: #cccccc; }
    .metric-change { font-size: 0.9rem; }
    .positive-change { color: #4CD964; }
    .negative-change { color: #FF3B30; }
    .footer { text-align: center; margin-top: 30px; font-size: 0.8rem; color: #666; }
    
    /* D3 Chart Styles */
    .bar { transition: all 0.3s ease; }
    .bar:hover { filter: brightness(1.2); }
    .axis-x path, .axis-y path { stroke: rgba(255, 255, 255, 0.3); }
    .axis-x .tick line, .axis-y .tick line { stroke: rgba(128, 128, 128, 0.2); }
    .axis-x text, .axis-y text { fill: white; font-size: 12px; font-family: 'aglet-sans', sans-serif; }
    .chart-title { fill: white; font-size: 18px; font-weight: bold; font-family: 'aglet-sans', sans-serif; text-anchor: middle; }
    .average-line { stroke: rgba(255, 255, 255, 0.7); stroke-width: 2; stroke-dasharray: 5,5; }
    .average-label { fill: white; font-size: 12px; font-family: 'aglet-sans', sans-serif; }
    .bar-value { fill: white; font-size: 10px; font-family: 'aglet-sans', sans-serif; text-anchor: middle; }
    .tooltip { 
      position: absolute; 
      padding: 10px; 
      background: #1D3B48; 
      color: white; 
      border: 1px solid #05D4BE; 
      border-radius: 5px; 
      pointer-events: none;
      font-family: 'aglet-sans', sans-serif;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 10;
    }
    
    #debugInfo { 
      background-color: rgba(5, 212, 190, 0.1); 
      padding: 10px; 
      margin-top: 20px; 
      border-radius: 5px; 
      white-space: pre; 
      font-family: 'aglet-sans', monospace; 
      font-size: 0.8rem; 
      max-height: 150px; 
      overflow: auto; 
      display: none; 
    }
    @media (max-width: 768px) {
      .controls-container { flex-direction: column; align-items: center; }
      .metric-card { min-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">    
    <div class="controls-container">
      <div class="control-group">
        <label for="yearSelect">Financial Year:</label>
        <select id="yearSelect"></select>
      </div>
      
      <div class="control-group">
        <label for="metricSelect">Financial Metric:</label>
        <select id="metricSelect">
          <option value="revenue">Revenue</option>
          <option value="wages">Wages</option>
          <option value="amortisation">Player Amortisation</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="sortSelect">Sort By:</label>
        <select id="sortSelect">
          <option value="value">Value (Descending)</option>
          <option value="name">Club Name</option>
          <option value="change">Year-over-year Change</option>
        </select>
      </div>
    </div>
    
    <div class="metrics-cards">
      <div class="metric-card">
        <div class="metric-title">Highest Value</div>
        <div id="highestValue" class="metric-value">£0M</div>
        <div id="highestClub" class="metric-subtitle">-</div>
      </div>
      
      <div class="metric-card">
        <div class="metric-title">League Total</div>
        <div id="leagueTotal" class="metric-value">£0M</div>
        <div id="totalChange" class="metric-change">-</div>
      </div>
      
      <div class="metric-card">
        <div class="metric-title">Highest Year-on-Year Growth</div>
        <div id="highestGrowth" class="metric-value">0%</div>
        <div id="growthClub" class="metric-subtitle">-</div>
      </div>
    </div>
    
    <div class="charts-container">
      <div class="chart-wrapper">
        <div id="barChart" style="width: 100%; height: 500px;"></div>
      </div>
      
      <div class="chart-wrapper">
        <div id="trendChart" style="width: 100%; height: 450px;"></div>
      </div>
    </div>
    
    <div id="debugInfo"></div>
    
          <div class="footer">
      Data last updated: 2025-04-08 14:26:59 | Source: Premier League Financial Records 2015-2024
      <div><small>Double-click on chart area to show data info</small></div>
    </div>
  </div>
  
  <div id="tooltip" class="tooltip"></div>
  
  <script>
    // Embedded data from SQL
    var rawData = [{"year":2022,"team":"West Ham United","revenue":252720000,"wages":135709000,"amortisation":48825000,"revenue_pct_change":31.1278070649,"wages_pct_change":4.8553216148,"amortisation_pct_change":-15.4618647736,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2023,"team":"West Ham United","revenue":236656000,"wages":137139,"amortisation":65306,"revenue_pct_change":-6.356441912,"wages_pct_change":-99.8989462747,"amortisation_pct_change":-99.8662447517,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2024,"team":"Liverpool","revenue":613764000,"wages":386086000,"amortisation":114479000,"revenue_pct_change":3.3558086744,"wages_pct_change":3.5413442895,"amortisation_pct_change":6.4465438045,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2024,"team":"Brighton and Hove Albion","revenue":222549000,"wages":146221000,"amortisation":39374000,"revenue_pct_change":8.8525311812,"wages_pct_change":14.6264982793,"amortisation_pct_change":20.1452459417,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2021,"team":"West Ham United","revenue":192728000,"wages":129425000,"amortisation":57755000,"revenue_pct_change":38.1562724014,"wages_pct_change":-1.0746688476,"amortisation_pct_change":-3.5100908848,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2020,"team":"West Ham United","revenue":139500000,"wages":130831000,"amortisation":59856000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2023,"team":"Brighton and Hove Albion","revenue":204450000,"wages":127563000,"amortisation":32772000,"revenue_pct_change":21.7246860878,"wages_pct_change":10.6702873404,"amortisation_pct_change":-27.8753466262,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2022,"team":"Chelsea","revenue":481278000,"wages":340249000,"amortisation":160400000,"revenue_pct_change":10.6734764742,"wages_pct_change":2.2060347547,"amortisation_pct_change":-2.1139481521,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2022,"team":"Brentford","revenue":142420000,"wages":68152000,"amortisation":22851000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2023,"team":"Liverpool","revenue":593836000,"wages":372881000,"amortisation":107546000,"revenue_pct_change":-0.0731989278,"wages_pct_change":1.8544518864,"amortisation_pct_change":4.7043246296,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2024,"team":"West Ham United","revenue":269740000,"wages":160969000,"amortisation":83489000,"revenue_pct_change":13.9797850044,"wages_pct_change":117276.5303815836,"amortisation_pct_change":127742.7709551955,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2022,"team":"Liverpool","revenue":594271000,"wages":366092000,"amortisation":102714000,"revenue_pct_change":21.9355103465,"wages_pct_change":16.4585149227,"amortisation_pct_change":-4.7277179509,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2023,"team":"Brentford","revenue":169018000,"wages":98800000,"amortisation":30903000,"revenue_pct_change":18.6757477882,"wages_pct_change":44.9700669093,"amortisation_pct_change":35.2369699357,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2023,"team":"Fulham","revenue":181188000,"wages":139064000,"amortisation":45617000,"revenue_pct_change":56.0808366211,"wages_pct_change":22.1241580385,"amortisation_pct_change":-19.1932969602,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2023,"team":"Chelsea","revenue":512467000,"wages":403962000,"amortisation":203250000,"revenue_pct_change":6.4804541242,"wages_pct_change":18.7254040423,"amortisation_pct_change":26.7144638404,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2022,"team":"Brighton and Hove Albion","revenue":167961000,"wages":115264000,"amortisation":45438000,"revenue_pct_change":19.870253142,"wages_pct_change":5.8594467507,"amortisation_pct_change":-2.0310478655,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2021,"team":"Chelsea","revenue":434863000,"wages":332905000,"amortisation":163864000,"revenue_pct_change":6.7405167378,"wages_pct_change":17.4350924227,"amortisation_pct_change":28.7206799579,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2020,"team":"Brighton and Hove Albion","revenue":123508000,"wages":103178000,"amortisation":45616000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2021,"team":"Fulham","revenue":116086000,"wages":113871000,"amortisation":56452000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2020,"team":"Liverpool","revenue":489860000,"wages":325572000,"amortisation":106034000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2021,"team":"Liverpool","revenue":487365000,"wages":314354000,"amortisation":107811000,"revenue_pct_change":-0.5093291961,"wages_pct_change":-3.4456280024,"amortisation_pct_change":1.6758775487,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2021,"team":"Brighton and Hove Albion","revenue":140119000,"wages":108884000,"amortisation":46380000,"revenue_pct_change":13.4493312174,"wages_pct_change":5.5302486964,"amortisation_pct_change":1.6748509295,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2020,"team":"Chelsea","revenue":407402000,"wages":283480000,"amortisation":127302000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2020,"team":"Leicester City","revenue":149950000,"wages":157479000,"amortisation":78273000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2021,"team":"Arsenal","revenue":327586000,"wages":244438000,"amortisation":117413000,"revenue_pct_change":-4.6198460925,"wages_pct_change":4.2477332628,"amortisation_pct_change":7.6058067709,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2020,"team":"Arsenal","revenue":343453000,"wages":234478000,"amortisation":109114000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2021,"team":"Leicester City","revenue":226204000,"wages":192088000,"amortisation":71953000,"revenue_pct_change":50.8529509837,"wages_pct_change":21.9768985071,"amortisation_pct_change":-8.0743040384,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2022,"team":"Arsenal","revenue":369077000,"wages":212345000,"amortisation":124567000,"revenue_pct_change":12.6656816836,"wages_pct_change":-13.1293006816,"amortisation_pct_change":6.0930220674,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2023,"team":"Leicester City","revenue":177326000,"wages":205780000,"amortisation":77029000,"revenue_pct_change":-17.3652080712,"wages_pct_change":13.0827100724,"amortisation_pct_change":6.5039751123,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2020,"team":"Tottenham Hotspur","revenue":402386000,"wages":181280000,"amortisation":75350000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2021,"team":"Tottenham Hotspur","revenue":361872000,"wages":204875,"amortisation":73812,"revenue_pct_change":-10.068441745,"wages_pct_change":-99.8869842233,"amortisation_pct_change":-99.9020411413,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2022,"team":"Leicester City","revenue":214590000,"wages":181973000,"amortisation":72325000,"revenue_pct_change":-5.134303549,"wages_pct_change":-5.2658156678,"amortisation_pct_change":0.5170041555,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2023,"team":"Arsenal","revenue":464557000,"wages":234766000,"amortisation":139060000,"revenue_pct_change":25.8699404189,"wages_pct_change":10.5587605077,"amortisation_pct_change":11.6347026098,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2020,"team":"Manchester City","revenue":478359000,"wages":351412000,"amortisation":145820000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2021,"team":"Manchester City","revenue":569849000,"wages":354689000,"amortisation":145697000,"revenue_pct_change":19.1258030057,"wages_pct_change":0.9325236475,"amortisation_pct_change":-0.0843505692,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2023,"team":"Manchester City","revenue":712768000,"wages":422053000,"amortisation":145448000,"revenue_pct_change":16.2727115531,"wages_pct_change":19.2641029046,"amortisation_pct_change":3.3686783978,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2024,"team":"Arsenal","revenue":613546000,"wages":327822000,"amortisation":171099000,"revenue_pct_change":32.0711990133,"wages_pct_change":39.637766968,"amortisation_pct_change":23.0396950956,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2022,"team":"Manchester City","revenue":613014000,"wages":353881000,"amortisation":140708000,"revenue_pct_change":7.5748136787,"wages_pct_change":-0.227805204,"amortisation_pct_change":-3.4242297371,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2024,"team":"Wolverhampton Wanderers","revenue":177697000,"wages":141925000,"amortisation":64168000,"revenue_pct_change":5.4112412873,"wages_pct_change":0.2302276146,"amortisation_pct_change":-19.0053644683,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2020,"team":"Wolverhampton Wanderers","revenue":132609000,"wages":94701000,"amortisation":51917000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2023,"team":"Nottingham Forest","revenue":154758000,"wages":144912000,"amortisation":40766000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2023,"team":"AFC Bournemouth","revenue":142997000,"wages":100109000,"amortisation":41226000,"revenue_pct_change":41.4803308533,"wages_pct_change":-7.1956318195,"amortisation_pct_change":-12.6012295951,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2021,"team":"Wolverhampton Wanderers","revenue":194096000,"wages":139262000,"amortisation":62140000,"revenue_pct_change":46.3671394853,"wages_pct_change":47.0544133642,"amortisation_pct_change":19.6910453223,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2023,"team":"Wolverhampton Wanderers","revenue":168575000,"wages":141599000,"amortisation":79225000,"revenue_pct_change":1.7602424257,"wages_pct_change":17.4208688874,"amortisation_pct_change":30.088175892,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2020,"team":"AFC Bournemouth","revenue":101072000,"wages":107871000,"amortisation":47170000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2022,"team":"Wolverhampton Wanderers","revenue":165659000,"wages":120591000,"amortisation":60901000,"revenue_pct_change":-14.6509974446,"wages_pct_change":-13.4071031581,"amortisation_pct_change":-1.9938847763,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2022,"team":"Southampton","revenue":150628000,"wages":113449000,"amortisation":35134000,"revenue_pct_change":-4.2080829279,"wages_pct_change":0.0202775378,"amortisation_pct_change":-25.7993664203,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2023,"team":"Southampton","revenue":145539000,"wages":122492000,"amortisation":51993000,"revenue_pct_change":-3.3785219216,"wages_pct_change":7.970982556,"amortisation_pct_change":47.9848579723,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2021,"team":"Southampton","revenue":157245000,"wages":113426000,"amortisation":47350000,"revenue_pct_change":24.1708518905,"wages_pct_change":-0.823656967,"amortisation_pct_change":-16.4519885662,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2020,"team":"Southampton","revenue":126636000,"wages":114368000,"amortisation":56674000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2022,"team":"Newcastle United","revenue":178185000,"wages":170204000,"amortisation":51139000,"revenue_pct_change":30.0478049849,"wages_pct_change":59.3237791236,"amortisation_pct_change":58.4378969545,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2021,"team":"Everton","revenue":193143000,"wages":182570000,"amortisation":81243000,"revenue_pct_change":3.9062415941,"wages_pct_change":10.8110076597,"amortisation_pct_change":-18.1282247662,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2022,"team":"Aston Villa","revenue":178399000,"wages":137044000,"amortisation":82535000,"revenue_pct_change":-2.8497211815,"wages_pct_change":-0.5478994768,"amortisation_pct_change":47.0556792873,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2021,"team":"Manchester United","revenue":464839000,"wages":312359000,"amortisation":120206000,"revenue_pct_change":-4.6405858942,"wages_pct_change":114969.2753441664,"amortisation_pct_change":97219.3973299222,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2020,"team":"Manchester United","revenue":487460000,"wages":271453,"amortisation":123517,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2023,"team":"Aston Villa","revenue":217694000,"wages":194236000,"amortisation":92519000,"revenue_pct_change":22.0264687582,"wages_pct_change":41.7325822364,"amortisation_pct_change":12.0966862543,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2020,"team":"Everton","revenue":185882000,"wages":164758000,"amortisation":99232000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2023,"team":"Tottenham Hotspur","revenue":549633000,"wages":251121000,"amortisation":109073000,"revenue_pct_change":23.7834100552,"wages_pct_change":20.0501960034,"amortisation_pct_change":37.1642354125,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2022,"team":"Tottenham Hotspur","revenue":444028000,"wages":209180000,"amortisation":79520000,"revenue_pct_change":22.7030552239,"wages_pct_change":102001.2812690665,"amortisation_pct_change":107633.1599197962,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2023,"team":"Newcastle United","revenue":247314000,"wages":186679000,"amortisation":86811000,"revenue_pct_change":38.7961949659,"wages_pct_change":9.6795609974,"amortisation_pct_change":69.754981521,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2021,"team":"Newcastle United","revenue":137015000,"wages":106829000,"amortisation":32277000,"revenue_pct_change":-8.2873704785,"wages_pct_change":-11.8179717036,"amortisation_pct_change":-32.1355732638,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2022,"team":"Everton","revenue":181007000,"wages":162010000,"amortisation":68327000,"revenue_pct_change":-6.2834273052,"wages_pct_change":-11.2614339705,"amortisation_pct_change":-15.8979850572,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2021,"team":"Aston Villa","revenue":183632000,"wages":137799000,"amortisation":56125000,"revenue_pct_change":63.0892749298,"wages_pct_change":26.6453445091,"amortisation_pct_change":-20.501706823,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2022,"team":"Manchester United","revenue":539937000,"wages":369513,"amortisation":148838,"revenue_pct_change":16.1557012213,"wages_pct_change":-99.8817024642,"amortisation_pct_change":-99.8761808895,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2023,"team":"Manchester United","revenue":601313000,"wages":347479000,"amortisation":170355000,"revenue_pct_change":11.3672521053,"wages_pct_change":93937.0162890074,"amortisation_pct_change":114356.6575740066,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2020,"team":"Aston Villa","revenue":112596000,"wages":108807000,"amortisation":70599000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2023,"team":"Everton","revenue":172155000,"wages":159026000,"amortisation":77621000,"revenue_pct_change":-4.8904186026,"wages_pct_change":-1.8418616135,"amortisation_pct_change":13.6022363048,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2020,"team":"Newcastle United","revenue":149396000,"wages":121146000,"amortisation":47561000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517},{"year":2024,"team":"Fulham","revenue":180686000,"wages":154754000,"amortisation":57400000,"revenue_pct_change":-0.277060291,"wages_pct_change":11.2825749295,"amortisation_pct_change":25.8302825701,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2024,"team":"Manchester City","revenue":715019000,"wages":412573000,"amortisation":165094000,"revenue_pct_change":0.3158110353,"wages_pct_change":-2.2461633965,"amortisation_pct_change":13.5072328255,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2024,"team":"AFC Bournemouth","revenue":169049000,"wages":136170000,"amortisation":61616000,"revenue_pct_change":18.2185640258,"wages_pct_change":36.0217363074,"amortisation_pct_change":49.4590792219,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2024,"team":"Nottingham Forest","revenue":189552000,"wages":166399000,"amortisation":61685000,"revenue_pct_change":22.4828441825,"wages_pct_change":14.8276195208,"amortisation_pct_change":51.3148211745,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2024,"team":"Newcastle United","revenue":317453000,"wages":218738000,"amortisation":96744000,"revenue_pct_change":28.3603030965,"wages_pct_change":17.1733296193,"amortisation_pct_change":11.4420983516,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2024,"team":"Manchester United","revenue":613444000,"wages":349507000,"amortisation":186528000,"revenue_pct_change":2.0174185491,"wages_pct_change":0.5836323922,"amortisation_pct_change":9.4937043233,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2024,"team":"Everton","revenue":186902000,"wages":157782,"amortisation":64581,"revenue_pct_change":8.5661177427,"wages_pct_change":-99.900782262,"amortisation_pct_change":-99.9167995774,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2024,"team":"Chelsea","revenue":468486000,"wages":338021000,"amortisation":190056000,"revenue_pct_change":-8.5822111473,"wages_pct_change":-16.3235650878,"amortisation_pct_change":-6.4915129151,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2024,"team":"Aston Villa","revenue":275695000,"wages":252049000,"amortisation":96548000,"revenue_pct_change":26.6433617831,"wages_pct_change":29.7643073375,"amortisation_pct_change":4.3547811801,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2024,"team":"Crystal Palace","revenue":189224000,"wages":133712000,"amortisation":45951000,"revenue_pct_change":5.085912943,"wages_pct_change":2.3624699524,"amortisation_pct_change":13.4956899746,"avg_revenue":346853733.3333333135,"total_revenue":5202806000,"avg_wages":221673585.4666666687,"total_wages":3325103782,"avg_amortisation":95619705.400000006,"total_amortisation":1434295581},{"year":2022,"team":"Crystal Palace","revenue":159999000,"wages":123835000,"amortisation":35342000,"revenue_pct_change":21.3188962944,"wages_pct_change":-2.4936615171,"amortisation_pct_change":-3.050419707,"avg_revenue":302073312.5,"total_revenue":4833173000,"avg_wages":175646719.5625,"total_wages":2810347513,"avg_amortisation":70679677.375,"total_amortisation":1130874838},{"year":2023,"team":"Crystal Palace","revenue":180066000,"wages":130626000,"amortisation":40487000,"revenue_pct_change":12.5419533872,"wages_pct_change":5.4839100416,"amortisation_pct_change":14.5577499859,"avg_revenue":306963684.2105262876,"total_revenue":5832310000,"avg_wages":199120270.4736842215,"total_wages":3783285139,"avg_amortisation":82724542.4210526347,"total_amortisation":1571766306},{"year":2021,"team":"Crystal Palace","revenue":131883000,"wages":127002000,"amortisation":36454000,"revenue_pct_change":-7.3510506017,"wages_pct_change":-4.25276871,"amortisation_pct_change":-15.977504264,"avg_revenue":269907812.5,"total_revenue":4318525000,"avg_wages":181881617.1875,"total_wages":2910105875,"avg_amortisation":75199613.25,"total_amortisation":1203193812},{"year":2020,"team":"Crystal Palace","revenue":142347000,"wages":132643000,"amortisation":43386000,"revenue_pct_change":null,"wages_pct_change":null,"amortisation_pct_change":null,"avg_revenue":248276000.0,"total_revenue":3972416000,"avg_wages":163267215.8125,"total_wages":2612275453,"avg_amortisation":72751719.8125,"total_amortisation":1164027517}];
    
    // Process data to ensure consistent types
    var data = rawData.map(function(item) {
      return {
        year: parseInt(item.year),
        team: item.team,
        revenue: parseFloat(item.revenue || 0),
        wages: parseFloat(item.wages || 0),
        amortisation: parseFloat(item.amortisation || 0),
        revenue_pct_change: parseFloat(item.revenue_pct_change || 0),
        wages_pct_change: parseFloat(item.wages_pct_change || 0),
        amortisation_pct_change: parseFloat(item.amortisation_pct_change || 0),
        avg_revenue: parseFloat(item.avg_revenue || 0),
        avg_wages: parseFloat(item.avg_wages || 0),
        avg_amortisation: parseFloat(item.avg_amortisation || 0),
        total_revenue: parseFloat(item.total_revenue || 0),
        total_wages: parseFloat(item.total_wages || 0),
        total_amortisation: parseFloat(item.total_amortisation || 0)
      };
    });
    
    // Debug function
    function showDebugInfo() {
      var debugDiv = document.getElementById('debugInfo');
      debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
      
      if (debugDiv.style.display === 'block') {
        var yearSample = {};
        var years = [...new Set(data.map(function(item) { return item.year; }))].sort();
        
        years.forEach(function(y) {
          yearSample[y] = data.filter(function(item) { return item.year === y; }).length;
        });
        
        var selectedYear = parseInt(document.getElementById('yearSelect').value);
        var selectedMetric = document.getElementById('metricSelect').value;
        var filtered = data.filter(function(item) { return item.year === selectedYear; });
        
        debugDiv.innerHTML = 'Data counts by year: ' + JSON.stringify(yearSample, null, 2) + 
                            '\n\nSelected year: ' + selectedYear +
                            '\n\nSelected metric: ' + selectedMetric +
                            '\n\nFirst few values: ' + JSON.stringify(filtered.slice(0, 3).map(item => item[selectedMetric]), null, 2) +
                            '\n\nSample records: \n' + JSON.stringify(filtered.slice(0, 3), null, 2);
      }
    }
    
    // Populate the year dropdown with unique years from the data
    var years = [...new Set(data.map(function(item) { return item.year; }))].sort();
    var yearSelect = document.getElementById('yearSelect');
    
    years.forEach(function(year) {
      var option = document.createElement('option');
      option.value = year;
      option.text = year;
      yearSelect.appendChild(option);
    });
    
    // Set to most recent year by default
    yearSelect.value = years[years.length - 1]; 
    
    // Utility functions
    function formatCurrency(value) { 
      return '£' + (value / 1000000).toFixed(1) + 'M'; 
    }
    
    function formatPercentage(value) { 
      if (isNaN(value)) return '-';
      return (value > 0 ? '+' : '') + value.toFixed(1) + '%';
    }
    
    // Function to update metrics cards
    function updateMetricsCards(filtered, selectedMetric, selectedYear) {
      // Ensure we have data for the selected year
      if (filtered.length === 0) return;
      
      // Highest value
      var maxValueItem = filtered.reduce(function(max, item) {
        return item[selectedMetric] > max[selectedMetric] ? item : max;
      }, filtered[0]);
      
      document.getElementById('highestValue').textContent = formatCurrency(maxValueItem[selectedMetric]);
      document.getElementById('highestClub').textContent = maxValueItem.team;
      
      // League total
      var totalKey = 'total_' + selectedMetric;
      var total = filtered[0][totalKey]; // All items in filtered have the same total value
      
      if (selectedYear === 2024) {
        document.getElementById('leagueTotal').textContent = "TBC";
        document.getElementById('totalChange').textContent = "Awaiting full accounts";
        document.getElementById('totalChange').className = 'metric-change';
      } else {
        document.getElementById('leagueTotal').textContent = formatCurrency(total);
        
        // Calculate total change from previous year if available
        var previousYear = selectedYear - 1;
        var previousYearData = data.filter(function(item) { return item.year === previousYear; });
        
        if (previousYearData.length > 0) {
          var prevTotal = previousYearData[0][totalKey]; // Get total from first record (all have same value)
          
          var totalChange = ((total - prevTotal) / prevTotal) * 100;
          var changeElement = document.getElementById('totalChange');
          changeElement.textContent = formatPercentage(totalChange);
          changeElement.className = 'metric-change ' + (totalChange >= 0 ? 'positive-change' : 'negative-change');
        } else {
          document.getElementById('totalChange').textContent = '-';
          document.getElementById('totalChange').className = 'metric-change';
        }
      }
      
      // Highest year-on-year growth
      var changeKey = selectedMetric + '_pct_change';
      var maxGrowthItem = filtered.reduce(function(max, item) {
        if (isNaN(item[changeKey])) return max;
        if (max[changeKey] === undefined || item[changeKey] > max[changeKey]) return item;
        return max;
      }, {});
      
      if (maxGrowthItem.team) {
        document.getElementById('highestGrowth').textContent = formatPercentage(maxGrowthItem[changeKey]);
        document.getElementById('growthClub').textContent = maxGrowthItem.team;
      } else {
        document.getElementById('highestGrowth').textContent = '-';
        document.getElementById('growthClub').textContent = '-';
      }
    }
    
    // Function to update the bar chart (D3.js implementation)
    function updateBarChart() {
      var selectedYear = parseInt(document.getElementById('yearSelect').value);
      var selectedMetric = document.getElementById('metricSelect').value;
      var sortBy = document.getElementById('sortSelect').value;
      
      console.log("Selected year:", selectedYear, "type:", typeof selectedYear);
      
      // Filter data for the selected year
      var filtered = data.filter(function(item) { 
        return item.year === selectedYear; 
      });
      
      console.log("Filtered data count:", filtered.length);
      
      // Check if there is data for the selected year
      if (filtered.length === 0) {
        document.getElementById('barChart').innerHTML = '<div style="text-align: center; padding: 50px; color: #FF3B30;">No data available for ' + selectedYear + '</div>';
        return;
      }
      
      // For year 2024, check for clubs with missing data and add placeholder
      if (selectedYear === 2024) {
        // Get all Premier League clubs from the most recent complete year (2023)
        var prevYearData = data.filter(function(item) { 
          return item.year === 2023; 
        });
        
        var currentTeams = filtered.map(function(item) { return item.team; });
        
        // Add placeholder for clubs missing 2024 data
        prevYearData.forEach(function(item) {
          if (!currentTeams.includes(item.team)) {
            filtered.push({
              year: 2024,
              team: item.team,
              revenue: 0,
              wages: 0,
              amortisation: 0,
              revenue_pct_change: 0,
              wages_pct_change: 0,
              amortisation_pct_change: 0,
              avg_revenue: filtered[0].avg_revenue,
              avg_wages: filtered[0].avg_wages,
              avg_amortisation: filtered[0].avg_amortisation,
              total_revenue: filtered[0].total_revenue,
              total_wages: filtered[0].total_wages,
              total_amortisation: filtered[0].total_amortisation,
              awaitingAccounts: true
            });
          }
        });
      }
      
      // Sort data based on selection
      if (sortBy === 'value') {
        filtered.sort(function(a, b) { return b[selectedMetric] - a[selectedMetric]; });
      } else if (sortBy === 'name') {
        filtered.sort(function(a, b) { return a.team.localeCompare(b.team); });
      } else if (sortBy === 'change') {
        var changeKey = selectedMetric + '_pct_change';
        filtered.sort(function(a, b) {
          if (isNaN(a[changeKey]) && isNaN(b[changeKey])) return 0;
          if (isNaN(a[changeKey])) return 1;
          if (isNaN(b[changeKey])) return -1;
          return b[changeKey] - a[changeKey];
        });
      }
      
      // Filter out "awaiting accounts" clubs for metrics calculations
      var metricsData = filtered.filter(function(item) {
        return !item.awaitingAccounts;
      });
      
      // Update metrics cards using only available data
      updateMetricsCards(metricsData.length > 0 ? metricsData : filtered, selectedMetric, selectedYear);
      
      // Clear previous chart
      d3.select("#barChart").html("");
      
      // Set up dimensions
      var chartContainer = document.getElementById('barChart');
      var width = chartContainer.clientWidth;
      var height = chartContainer.clientHeight;
      var margin = {top: 60, right: 40, bottom: 120, left: 80};
      var innerWidth = width - margin.left - margin.right;
      var innerHeight = height - margin.top - margin.bottom;
      
      // Get data ready for chart
      var teams = filtered.map(function(item) { return item.team; });
      var values = filtered.map(function(item) { return Number(item[selectedMetric]); });
      var avgKey = 'avg_' + selectedMetric;
      var average = filtered[0][avgKey];
      
      // Create SVG container
      var svg = d3.select("#barChart")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
      
      // Create main group with margin
      var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      
      // Set up scales
      var xScale = d3.scaleBand()
        .domain(teams)
        .range([0, innerWidth])
        .padding(0.2);
      
      var maxValue = d3.max(values);
      var yScale = d3.scaleLinear()
        .domain([0, maxValue])
        .range([innerHeight, 0]);
      
      // Color scale for bars
      var colorScale = function(value) {
        return value > average ? '#05D4BE' : '#FF3B30';
      };
      
      // Create bars
      g.selectAll(".bar")
        .data(filtered)
        .enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", function(d) { return xScale(d.team); })
        .attr("y", function(d) { 
          if (d.awaitingAccounts) { 
            return innerHeight - 30; // Small bar to indicate awaiting accounts
          } else { 
            return yScale(d[selectedMetric]); 
          }
        })
        .attr("width", xScale.bandwidth())
        .attr("height", function(d) { 
          if (d.awaitingAccounts) { 
            return 30; // Fixed height for awaiting accounts
          } else { 
            return innerHeight - yScale(d[selectedMetric]); 
          }
        })
        .attr("fill", function(d) { 
          if (d.awaitingAccounts) { 
            return "rgba(150, 150, 150, 0.3)"; // Gray for awaiting accounts
          } else { 
            return colorScale(d[selectedMetric]); 
          }
        })
        .attr("stroke", "rgba(255, 255, 255, 0.5)")
        .attr("stroke-width", 1)
        .on("mouseover", function(event, d) {
          // Highlight bar
          d3.select(this)
            .attr("stroke-width", 2);
          
          // Show tooltip
          var tooltipContent = '<b>' + d.team + '</b><br>';
          
          if (d.awaitingAccounts) {
            tooltipContent += '<i>Awaiting 2024 Financial Accounts</i>';
          } else {
            var changeKey = selectedMetric + '_pct_change';
            var percentFromAvg = ((d[selectedMetric] / d[avgKey]) * 100 - 100).toFixed(1);
            var changeText = isNaN(d[changeKey]) ? 'N/A' : formatPercentage(d[changeKey]);
            
            tooltipContent += selectedMetric.charAt(0).toUpperCase() + selectedMetric.slice(1) + ': ' + formatCurrency(d[selectedMetric]) + '<br>' +
                            'vs League Avg: ' + percentFromAvg + '%<br>' +
                            'YoY Change: ' + changeText;
          }
                              
          var tooltip = d3.select("#tooltip")
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 20) + "px")
            .style("opacity", 1);
            
          tooltip.html(tooltipContent);
        })
        .on("mouseout", function() {
          // Restore bar style
          d3.select(this)
            .attr("stroke-width", 1);
          
          // Hide tooltip
          d3.select("#tooltip")
            .style("opacity", 0);
        });
      
      // Add bar value labels
      g.selectAll(".bar-value")
        .data(filtered)
        .enter()
        .append("text")
        .attr("class", "bar-value")
        .attr("x", function(d) { return xScale(d.team) + xScale.bandwidth() / 2; })
        .attr("y", function(d) { 
          if (d.awaitingAccounts) { 
            return innerHeight - 45; // Position well above the small bar
          } else { 
            return yScale(d[selectedMetric]) - 5; 
          }
        })
        .attr("text-anchor", "middle")
        .style("font-size", function(d) {
          return d.awaitingAccounts ? "8px" : "10px"; // Smaller font for awaiting accounts
        })
        .text(function(d) { 
          if (d.awaitingAccounts) { 
            return "Awaiting"; 
          } else { 
            return formatCurrency(d[selectedMetric]); 
          }
        });
        
      // Add second line for awaiting accounts
      g.selectAll(".bar-value-line2")
        .data(filtered.filter(function(d) { return d.awaitingAccounts; }))
        .enter()
        .append("text")
        .attr("class", "bar-value")
        .attr("x", function(d) { return xScale(d.team) + xScale.bandwidth() / 2; })
        .attr("y", function(d) { return innerHeight - 35; })
        .attr("text-anchor", "middle")
        .style("font-size", "8px")
        .text("Accounts");
      
      // Add X axis
      g.append("g")
        .attr("class", "axis-x")
        .attr("transform", "translate(0," + innerHeight + ")")
        .call(d3.axisBottom(xScale))
        .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em");
      
      // Add Y axis
      g.append("g")
        .attr("class", "axis-y")
        .call(d3.axisLeft(yScale)
          .tickFormat(function(d) { return "£" + (d / 1000000).toFixed(0) + "M"; }));
      
      // Add Y axis label
      g.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", -60)
        .attr("x", -(innerHeight / 2))
        .attr("text-anchor", "middle")
        .style("fill", "white")
        .style("font-size", "14px")
        .text(selectedMetric.charAt(0).toUpperCase() + selectedMetric.slice(1) + " (in millions £)");
      
      // Add title
      svg.append("text")
        .attr("class", "chart-title")
        .attr("x", width / 2)
        .attr("y", 30)
        .text(selectedMetric.charAt(0).toUpperCase() + selectedMetric.slice(1) + " for Premier League Clubs (" + selectedYear + ")");
      
      // Add average line
      g.append("line")
        .attr("class", "average-line")
        .attr("x1", 0)
        .attr("x2", innerWidth)
        .attr("y1", yScale(average))
        .attr("y2", yScale(average));
      
      // Add average label
      g.append("text")
        .attr("class", "average-label")
        .attr("x", innerWidth - 5)
        .attr("y", yScale(average) - 5)
        .attr("text-anchor", "end")
        .text("League Average: " + formatCurrency(average))
        .attr("fill", "white")
        .attr("padding", "4px")
        .attr("background", "rgba(0,0,0,0.5)");
    }
    
    // Function to update the trend chart (D3.js implementation)
    function updateTrendChart() {
      var selectedMetric = document.getElementById('metricSelect').value;
      
      // Clear previous chart
      d3.select("#trendChart").html("");
      
      // Get the averages and totals for each year (limit to 2023)
      var yearlyData = [];
      years.forEach(function(year) {
        // Skip data for 2024
        if (year > 2023) {
          return;
        }
        
        var yearData = data.filter(function(item) { return item.year === year; });
        if (yearData.length > 0) {
          var totalKey = 'total_' + selectedMetric;
          var total = yearData[0][totalKey]; // All records for this year have the same total
          
          var maxItem = yearData.reduce(function(max, item) { 
            return item[selectedMetric] > max[selectedMetric] ? item : max; 
          }, yearData[0]);
          
          yearlyData.push({
            year: year,
            total: total,
            max: maxItem[selectedMetric],
            maxClub: maxItem.team
          });
        }
      });
      
      // Set up dimensions
      var chartContainer = document.getElementById('trendChart');
      var width = chartContainer.clientWidth;
      var height = chartContainer.clientHeight;
      var margin = {top: 50, right: 40, bottom: 60, left: 80};
      var innerWidth = width - margin.left - margin.right;
      var innerHeight = height - margin.top - margin.bottom;
      
      // Create SVG container
      var svg = d3.select("#trendChart")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
      
      // Create main group with margin
      var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      
      // Set up scales
      var xScale = d3.scaleBand()
        .domain(yearlyData.map(function(d) { return d.year; }))
        .range([0, innerWidth])
        .padding(0.2);
      
      var maxTotal = d3.max(yearlyData, function(d) { return d.total; });
      var maxValue = d3.max(yearlyData, function(d) { return d.max; });
      var yMax = Math.max(maxTotal, maxValue);
      
      var yScale = d3.scaleLinear()
        .domain([0, yMax])
        .range([innerHeight, 0]);
      
      // Create line generators
      var totalLine = d3.line()
        .x(function(d) { return xScale(d.year) + xScale.bandwidth() / 2; })
        .y(function(d) { return yScale(d.total); })
        .curve(d3.curveMonotoneX);
      
      var maxLine = d3.line()
        .x(function(d) { return xScale(d.year) + xScale.bandwidth() / 2; })
        .y(function(d) { return yScale(d.max); })
        .curve(d3.curveMonotoneX);
      
      // Add X axis
      g.append("g")
        .attr("class", "axis-x")
        .attr("transform", "translate(0," + innerHeight + ")")
        .call(d3.axisBottom(xScale));
      
      // Add Y axis
      g.append("g")
        .attr("class", "axis-y")
        .call(d3.axisLeft(yScale)
          .tickFormat(function(d) { return "£" + (d / 1000000).toFixed(0) + "M"; }));
      
      // Add Y axis label
      g.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", -60)
        .attr("x", -(innerHeight / 2))
        .attr("text-anchor", "middle")
        .style("fill", "white")
        .style("font-size", "14px")
        .text(selectedMetric.charAt(0).toUpperCase() + selectedMetric.slice(1) + " (in millions £)");
      
      // Add title
      svg.append("text")
        .attr("class", "chart-title")
        .attr("x", width / 2)
        .attr("y", 20)
        .text(selectedMetric.charAt(0).toUpperCase() + selectedMetric.slice(1) + " Trends (2015-2023)");
      
      // Draw total line
      g.append("path")
        .datum(yearlyData)
        .attr("fill", "none")
        .attr("stroke", "#05D4BE")
        .attr("stroke-width", 3)
        .attr("d", totalLine);
      
      // Draw max line
      g.append("path")
        .datum(yearlyData)
        .attr("fill", "none")
        .attr("stroke", "#FF9500")
        .attr("stroke-width", 3)
        .attr("d", maxLine);
      
      // Add points for total
      g.selectAll(".total-point")
        .data(yearlyData)
        .enter()
        .append("circle")
        .attr("class", "total-point")
        .attr("cx", function(d) { return xScale(d.year) + xScale.bandwidth() / 2; })
        .attr("cy", function(d) { return yScale(d.total); })
        .attr("r", 6)
        .attr("fill", "#05D4BE")
        .attr("stroke", "white")
        .attr("stroke-width", 1)
        .on("mouseover", function(event, d) {
          // Highlight point
          d3.select(this)
            .attr("r", 8)
            .attr("stroke-width", 2);
          
          // Show tooltip
          var tooltipContent = 'Year: ' + d.year + '<br>Total ' + 
                             selectedMetric + ': ' + formatCurrency(d.total);
                             
          var tooltip = d3.select("#tooltip")
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 20) + "px")
            .style("opacity", 1);
            
          tooltip.html(tooltipContent);
        })
        .on("mouseout", function() {
          // Restore point style
          d3.select(this)
            .attr("r", 6)
            .attr("stroke-width", 1);
          
          // Hide tooltip
          d3.select("#tooltip")
            .style("opacity", 0);
        });
      
      // Add points for max
      g.selectAll(".max-point")
        .data(yearlyData)
        .enter()
        .append("circle")
        .attr("class", "max-point")
        .attr("cx", function(d) { return xScale(d.year) + xScale.bandwidth() / 2; })
        .attr("cy", function(d) { return yScale(d.max); })
        .attr("r", 6)
        .attr("fill", "#FF9500")
        .attr("stroke", "white")
        .attr("stroke-width", 1)
        .on("mouseover", function(event, d) {
          // Highlight point
          d3.select(this)
            .attr("r", 8)
            .attr("stroke-width", 2);
          
          // Show tooltip
          var tooltipContent = 'Year: ' + d.year + '<br>Highest ' + 
                             selectedMetric + ': ' + formatCurrency(d.max) + 
                             '<br>Club: ' + d.maxClub;
                             
          var tooltip = d3.select("#tooltip")
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 20) + "px")
            .style("opacity", 1);
            
          tooltip.html(tooltipContent);
        })
        .on("mouseout", function() {
          // Restore point style
          d3.select(this)
            .attr("r", 6)
            .attr("stroke-width", 1);
          
          // Hide tooltip
          d3.select("#tooltip")
            .style("opacity", 0);
        });
      
      // Add legend
      var legend = svg.append("g")
        .attr("transform", "translate(" + (width/2 - 100) + "," + (margin.top - 20) + ")");
      
      // Legend for total
      legend.append("rect")
        .attr("x", 0)
        .attr("width", 20)
        .attr("height", 10)
        .attr("fill", "#05D4BE");
        
      legend.append("text")
        .attr("x", 30)
        .attr("y", 8)
        .text("League Total")
        .attr("font-size", "12px")
        .attr("fill", "white");
      
      // Legend for max
      legend.append("rect")
        .attr("x", 150)
        .attr("width", 20)
        .attr("height", 10)
        .attr("fill", "#FF9500");
        
      legend.append("text")
        .attr("x", 180)
        .attr("y", 8)
        .text("Highest Value")
        .attr("font-size", "12px")
        .attr("fill", "white");
    }
    
    // Event listeners
    document.getElementById('yearSelect').addEventListener('change', updateBarChart);
    document.getElementById('metricSelect').addEventListener('change', function() {
      updateBarChart();
      updateTrendChart();
    });
    document.getElementById('sortSelect').addEventListener('change', updateBarChart);
    
    // Add event listener for debug function
    document.getElementById('barChart').addEventListener('dblclick', showDebugInfo);
    document.getElementById('trendChart').addEventListener('dblclick', showDebugInfo);
    
    // Initial render
    updateBarChart();
    updateTrendChart();
  </script>
</body>
</html>
