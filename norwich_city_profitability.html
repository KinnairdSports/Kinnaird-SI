
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Norwich City - Profitability Analysis</title>
    <!-- Load Aglet Sans from Typekit -->
    <link href="https://use.typekit.net/xxs6huv.css" rel="stylesheet">
    <!-- Add Open Sans as fallback from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      :root {
        /* Updated color scheme with black background */
        --background: #000000;
        --text: #FFFFFF;
        --muted-text: #CCCCCC;
        --primary: #05D4BE;
        --primary-light: rgba(5, 212, 190, 0.2);
        --primary-dark: #04A599;
        --secondary: #5F84FB;
        --secondary-light: rgba(95, 132, 251, 0.2);
        --accent: #FF9500;
        --accent-light: rgba(255, 149, 0, 0.2);
        --grid: rgba(255, 255, 255, 0.25);
        --line: rgba(255, 255, 255, 0.3);
        --tooltip-bg: #111111;
        --card-bg: rgba(20, 20, 20, 0.7);
        --highlight: rgba(5, 212, 190, 0.1);
        --total: #9C68F5;
        --zero-line: rgba(255, 255, 255, 0.5);
        
        /* Profitability metrics colors */
        --ebitda: #05D4BE;         /* Teal */
        --ebit: #4D7AFF;           /* Blue */
        --operating: #07887B;      /* Dark teal */
        --before-interest: #FF9500; /* Orange */
        --before-tax: #E83E8C;     /* Pink */
        --after-tax: #9C68F5;      /* Purple */
      }
      
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
          background-color: #000000;
          color: white;
          font-family: 'aglet-sans', sans-serif;
          padding: 20px;
          margin: 0;
          min-height: 100vh;
      }
      
      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
          background-color: #000000;
      }
      
      .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
          border-bottom: 1px solid rgba(5, 212, 190, 0.3);
          padding-bottom: 10px;
      }
      
      .club-info {
          display: flex;
          flex-direction: column;
      }
      
      .profit-title {
          font-size: 1.2rem;
          color: #cccccc;
          font-weight: normal;
      }
      
      .team-performance {
          font-size: 1rem;
          color: #cccccc;
          margin-top: 5px;
      }
      
      .metrics-cards {
          display: flex;
          justify-content: space-between;
          margin-bottom: 20px;
          flex-wrap: wrap;
          gap: 15px;
          width: 100%;
          padding: 0;
          box-sizing: border-box;
      }
      
      .metric-card {
          background: linear-gradient(135deg, rgba(5, 212, 190, 0.2), rgba(95, 132, 251, 0.2));
          border-radius: 8px;
          padding: 15px;
          flex: 1;
          min-width: 180px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          border: 1px solid rgba(5, 212, 190, 0.3);
          text-align: center;
      }
      
      .metric-title { 
          font-size: 1rem; 
          color: #cccccc; 
      }
      
      .metric-value { 
          font-size: 2rem; 
          font-weight: bold; 
          margin: 10px 0; 
          color: #05D4BE; 
      }
      
      .metric-subtitle {
          font-size: 0.9rem;
          color: #cccccc;
      }
      
      .metric-change {
          font-size: 0.9rem;
      }
      
      .positive-change {
          color: #4CD964;
      }
      
      .negative-change {
          color: #FF3B30;
      }
      
      .neutral {
          color: #05D4BE;
      }
      
      .group-title {
      font-size: 1rem;
      font-weight: bold;
      color: #05D4BE;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(5, 212, 190, 0.2);
  }
  
  .cost-checkbox {
      display: flex;
      align-items: center;
      padding: 6px 12px;
      margin-right: 8px;
      border-radius: 6px;
      transition: all 0.2s;
      border: 1px solid rgba(5, 212, 190, 0.2);
      background-color: rgba(5, 212, 190, 0.05);
  }
  
  .cost-checkbox:hover {
      background-color: rgba(5, 212, 190, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
  }
  
  .cost-checkbox label {
      cursor: pointer;
      user-select: none;
      font-weight: 500;
      text-align: left;
  }
  
  .cost-checkbox input[type="checkbox"] {
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      min-width: 18px;
      border: 2px solid #05D4BE;
      border-radius: 4px;
      outline: none;
      transition: all 0.2s;
      position: relative;
      background-color: rgba(255, 255, 255, 0.05);
      margin-right: 8px;
  }
  
  .cost-checkbox input[type="checkbox"]:checked {
      background-color: #05D4BE;
  }
  
  .cost-checkbox input[type="checkbox"]:checked + label {
      color: #05D4BE;
  }
      
      .chart-wrapper {
          background-color: rgba(5, 212, 190, 0.05);
          border-radius: 8px;
          padding: 15px;
          border: 1px solid rgba(5, 212, 190, 0.2);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          margin-bottom: 20px;
          position: relative;
      }
      
      .chart-wrapper:hover {
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      }
      
      /* Renamed chart-title to panel-title to match the other template */
      
      #mainChart {
          width: 100%;
          height: 500px;
          position: relative;
      }
      
      svg text {
          font-family: 'aglet-sans', 'Open Sans', sans-serif;
          fill: var(--text);
      }
      
      .axis-x path, .axis-y path {
          stroke: var(--line);
          stroke-width: 1.5;
      }
      
      .axis-x .tick line, .axis-y .tick line {
          stroke: var(--grid);
          stroke-dasharray: 2,2;
      }
      
      .axis-x text, .axis-y text {
          fill: var(--text);
          font-size: 12px;
          font-weight: 500;
      }
      
      .tooltip {
          position: absolute;
          padding: 12px 15px;
          background: var(--tooltip-bg);
          color: var(--text);
          border: 1px solid var(--primary);
          border-radius: 8px;
          pointer-events: none;
          font-family: 'aglet-sans', 'Open Sans', sans-serif;
          font-size: 14px;
          opacity: 0;
          transition: all 0.3s;
          z-index: 10;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
          max-width: 300px;
          backdrop-filter: blur(4px);
      }
      
      .tooltip-header {
          margin-bottom: 5px;
      }
      
      .tooltip-title {
          font-weight: bold;
          color: var(--primary);
          margin-bottom: 4px;
          font-size: 16px;
      }
      
      .tooltip-subtitle {
          color: var(--muted-text);
          font-size: 13px;
          margin-bottom: 8px;
      }
      
      .tooltip-divider {
          height: 1px;
          background-color: rgba(255, 255, 255, 0.2);
          margin: 8px 0;
          width: 100%;
      }
      
      .tooltip-item {
          display: flex;
          justify-content: space-between;
          margin-bottom: 4px;
      }
      
      .tooltip-item-value {
          font-weight: bold;
          margin-left: 15px;
      }
      
      .legend {
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
          margin-top: 20px;
          padding: 15px;
          background-color: rgba(0, 0, 0, 0.2);
          border-radius: 8px;
          border: 1px solid rgba(255, 255, 255, 0.1);
          justify-content: center;
      }
      
      .legend-item {
          display: flex;
          align-items: center;
          gap: 8px;
          cursor: help;
          padding: 6px 12px;
          border-radius: 6px;
          transition: all 0.2s;
          user-select: none;
          position: relative;
          opacity: 1;
      }
      
      .legend-item.inactive {
          opacity: 0.5;
      }
      
      .legend-item:hover {
          background-color: rgba(255, 255, 255, 0.1);
          transform: translateY(-2px);
      }
      
      .legend-color {
          width: 16px;
          height: 16px;
          border-radius: 4px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      
      .legend-label {
          font-weight: 500;
      }
      
      .legend-tooltip {
          position: absolute;
          bottom: 100%;
          left: 50%;
          transform: translateX(-50%);
          min-width: 200px;
          max-width: 250px;
          background-color: var(--tooltip-bg);
          color: var(--text);
          padding: 10px 12px;
          border-radius: 6px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          border: 1px solid var(--primary);
          z-index: 100;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s;
          font-size: 0.9rem;
          margin-bottom: 10px;
      }
      
      .legend-tooltip::after {
          content: "";
          position: absolute;
          top: 100%;
          left: 50%;
          margin-left: -8px;
          border-width: 8px;
          border-style: solid;
          border-color: var(--primary) transparent transparent transparent;
      }
      
      .legend-item:hover .legend-tooltip {
          opacity: 1;
          visibility: visible;
      }
      
      .legend-tooltip-title {
          font-weight: bold;
          color: var(--primary);
          margin-bottom: 5px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.2);
          padding-bottom: 3px;
      }
      
      /* Analysis panel */
      .panel-title {
          font-size: 1.1rem;
          margin-bottom: 10px;
          color: #05D4BE;
          border-bottom: 1px solid rgba(5, 212, 190, 0.3);
          padding-bottom: 5px;
      }
      
      .metrics-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-bottom: 20px;
      }
      
      .metric-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 8px;
          font-size: 0.9rem;
      }
      
      .metric-label {
          color: #cccccc;
      }
      
      .metric-row .metric-value {
          font-size: inherit;
          font-weight: bold;
          color: white;
          margin: 0;
      }
      
      /* Added to match the cost structure template */
.hover-instruction {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: #05D4BE;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      opacity: 0.7;
      transition: opacity 0.3s;
      z-index: 10;
      border: 1px solid rgba(5, 212, 190, 0.3);
}
.hover-instruction:hover {
      opacity: 1;
}
      .vertical-guide {
          pointer-events: none;
          stroke: var(--primary);
          stroke-width: 1.5;
          stroke-dasharray: 5,3;
      }
      
      .guide-circle {
          pointer-events: none;
          fill: var(--primary);
          stroke: white;
          stroke-width: 1.5;
      }
      
      /* Add smooth transitions to the chart */
      .line {
          transition: opacity 0.3s;
      }
      
      .zero-line {
          stroke: var(--zero-line);
          stroke-width: 1.5;
          stroke-dasharray: 4,4;
      }
      
      /* Footer styles moved to inline style */

      /* RESPONSIVE DESIGN STYLES - Added from first code template */
      @media (max-width: 992px) {
        .container {
          padding: 15px;
        }
        .metrics-cards {
          flex-wrap: wrap;
          gap: 10px;
        }
        /* Keep cards in row with adjusted width */
        .metric-card {
          flex: 1 0 calc(33.333% - 10px);
          padding: 12px;
        }
        .metric-value {
          font-size: 1.8rem;
          margin: 8px 0;
        }
        #mainChart {
          height: 450px !important;
        }
        /* Chart title styling removed as we're using panel-title */
        .metric-filter {
          padding: 12px;
        }
      }
      
      @media (max-width: 768px) {
        .container {
          padding: 10px 5px;
        }
        .header {
          flex-direction: column;
          align-items: flex-start;
        }
        /* Convert to vertical stack on tablet and ensure same width as graph */
        .metrics-cards {
          display: block; /* Change to block to ensure full width */
          width: 100%;
          gap: 0;
          padding: 0;
        }
        .metric-card {
          width: 100%;
          max-width: 100%;
          flex: none;
          margin: 0 0 10px 0; /* Add bottom margin only */
          padding: 10px;
          box-sizing: border-box; /* Ensure padding is included in width */
        }
        .metric-value {
          font-size: 1.5rem;
          margin: 6px 0;
        }
        .metric-subtitle {
          font-size: 0.85rem;
        }
        .metrics-grid {
          grid-template-columns: 1fr;
        }
        .panel-title {
          font-size: 1rem;
        }
        #mainChart {
          height: 400px !important;
        }
        /* Chart title styling removed as we're using panel-title */
        .chart-wrapper {
          padding: 15px;
        }
        .cost-checkbox {
          padding: 5px 10px;
        }
        .group-title {
          font-size: 0.9rem;
        }
        .metric-section {
          margin-bottom: 10px;
          margin-right: 0;
          width: 100%;
        }
        .metric-filter {
          padding: 10px;
          flex-direction: column;
        }
        .tooltip {
          max-width: 260px;
        }
      }
      
      @media (max-width: 480px) {
        body {
          padding: 5px;
        }
        .container {
          padding: 5px;
        }
        /* Ensure cards match graph width exactly on mobile */
        .metrics-cards {
          width: 100%;
          padding: 0;
        }
        .metric-card {
          width: 100%;
          padding: 8px;
          margin: 0 0 8px 0;
          box-sizing: border-box;
          max-width: 100%;
        }
        .metric-title {
          font-size: 0.85rem;
        }
        .metric-value {
          font-size: 1.3rem;
          margin: 5px 0;
        }
        .metric-subtitle {
          font-size: 0.75rem;
        }
        #mainChart {
          height: 300px !important;
        }
        .chart-wrapper {
          padding: 10px;
          margin-bottom: 15px;
        }
        /* Chart title styling removed as we're using panel-title */
        .legend {
          padding: 10px 5px;
          gap: 5px;
        }
        .legend-item {
          padding: 4px 8px;
          font-size: 0.8rem;
        }
        .cost-checkbox label {
          font-size: 0.8rem;
        }
        .cost-checkbox input[type="checkbox"] {
          width: 16px;
          height: 16px;
          min-width: 16px;
        }
        .tooltip {
          max-width: 240px;
          font-size: 12px;
          padding: 8px 10px;
        }
        .tooltip-title {
          font-size: 14px;
        }
        .footer {
          margin-top: 20px;
          font-size: 0.8rem;
        }
        .panel-title {
          font-size: 0.9rem;
        }
        .metric-row {
          font-size: 0.8rem;
        }
      }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="club-info">
                <div class="profit-title">Profitability Analysis</div>
            </div>
        </div>
        
        <div class="metrics-cards">
            <div class="metric-card">
                <div class="metric-title">EBITDA</div>
                <div class="metric-value">£29.4M</div>
                <div class="metric-subtitle">£-5.8M vs Premier League avg</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">EBIT</div>
                <div class="metric-value">£3.1M</div>
                <div class="metric-subtitle">£+46.9M vs Premier League avg</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Profit After Tax</div>
                <div class="metric-value">£-17.8M</div>
                <div class="metric-subtitle">£+10.1M vs Premier League avg</div>
            </div>
        </div>
        
        <div class="chart-wrapper">
            <div class="panel-title">Profitability Metrics Over Time</div>
            
            <!-- Integrated controls with inline styles to match cost structure template exactly -->
<div style="margin-bottom: 20px; background-color: rgba(0, 0, 0, 0.2); border-radius: 8px; padding: 15px;">
    <div style="display: flex; flex-wrap: wrap; width: 100%; gap: 20px; justify-content: space-between;">
        <!-- Underlying Profitability Section -->
        <div style="min-width: min(100%, 250px); flex: 1;">
            <div class="group-title">Underlying Profitability</div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                <div class="cost-checkbox">
                    <input type="checkbox" id="ebitda" checked>
                    <label for="ebitda">EBITDA</label>
                </div>
                
                <div class="cost-checkbox">
                    <input type="checkbox" id="ebit" checked>
                    <label for="ebit">EBIT</label>
                </div>
            </div>
        </div>
        
        <!-- Statutory Profitability Section -->
        <div style="min-width: min(100%, 250px); flex: 1;">
            <div class="group-title">Statutory Profitability</div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                <div class="cost-checkbox">
                    <input type="checkbox" id="operating_profit_loss">
                    <label for="operating_profit_loss">Operating Profit/Loss</label>
                </div>
                
                <div class="cost-checkbox">
                    <input type="checkbox" id="profit_loss_before_tax">
                    <label for="profit_loss_before_tax">Profit/Loss Before Tax</label>
                </div>
                
                <div class="cost-checkbox">
                    <input type="checkbox" id="profit_loss_after_tax">
                    <label for="profit_loss_after_tax">Profit/Loss After Tax</label>
                </div>
            </div>
        </div>
    </div>
</div>
            
            <div id="mainChart" style="width: 100%; height: 500px; position: relative;"></div>
            <div class="legend" id="chartLegend"></div>
        </div>
        
        <div class="chart-wrapper">
            <div class="panel-title">Profitability Analysis</div>
            <div class="metrics-grid">
                <div>
                    <div class="metric-row">
                        <span class="metric-label">Year-on-Year Change</span>
                        <span class="metric-value"><span class="negative-change">-1004.2%</span></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">5 Year Profit Trend</span>
                        <span class="metric-value">Insufficient data</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Most Profitable Year</span>
                        <span class="metric-value">2020 (£2.0M)</span>
                    </div>
                </div>
                <div>
                    <div class="metric-row">
                        <span class="metric-label">Profit Margin</span>
                        <span class="metric-value">-13.3%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">EBITDA Margin</span>
                        <span class="metric-value">21.9%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Tax Efficiency</span>
                        <span class="metric-value">-75.7%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer" style="text-align: center; margin-top: 30px; font-size: 0.8rem; color: #666;">
            <p>Data sourced from Companies House | Visualisation by Kinnaird Analytics</p>
        </div>
    </div>
    
    <div id="tooltip" class="tooltip"></div>
    
    <script>
      // Data for the chart
      const financialYears = [2020, 2022];
      
      // Profitability metrics data
      const metricsData = {
          ebitda: [11751000.0, 29357000.0],
          ebit: [587000.0, 3051000.0],
          operating_profit_loss: [2139000.0, 3000000.0],
          profit_loss_before_interest_tax: [8802000.0, -392000.0], // Kept for data integrity
          profit_loss_before_tax: [2139000.0, -23576000.0],
          profit_loss_after_tax: [1974000.0, -17849000.0]
      };
      
      const positionData = ["20th", "20th"];
      const leagueData = ["Premier League", "Premier League"];
      const revenueData = [119352000.0, 133869000.0];
      
      // Metrics settings
      const metricsConfig = {
          ebitda: {
              label: "EBITDA",
              color: "var(--ebitda)",
              description: "Earnings Before Interest, Tax, Depreciation, and Amortization - a measure of underlying operational performance excluding non-cash expenses and financing costs."
          },
          ebit: {
              label: "EBIT",
              color: "var(--ebit)",
              description: "Earnings Before Interest and Tax - a measure of underlying profitability before financing and tax expenses."
          },
          operating_profit_loss: {
              label: "Operating Profit/Loss",
              color: "var(--operating)",
              description: "Operating Profit/Loss - reflects statutory earnings from core business operations before interest and taxes."
          },
          profit_loss_before_tax: {
              label: "Profit/Loss Before Tax",
              color: "var(--before-tax)",
              description: "Profit/Loss Before Tax - shows statutory earnings after interest expenses but before tax obligations."
          },
          profit_loss_after_tax: {
              label: "Profit/Loss After Tax",
              color: "var(--after-tax)",
              description: "Profit/Loss After Tax - the club's final statutory profit or loss figure after all expenses, including tax."
          }
      };
      
      // All available metrics for complete legend
      const allMetrics = ['ebitda', 'ebit', 'operating_profit_loss', 'profit_loss_before_tax', 'profit_loss_after_tax'];
      
      // Active metrics selection
      let selectedMetrics = ['ebitda', 'ebit'];
      
      // Helper function to format currency values
      function formatCurrency(value) {
          if (value === null || value === undefined) return "N/A";
          
          if (value >= 1000000000 || value <= -1000000000) {
              return `£${(value/1000000000).toFixed(2)}B`;
          } else if (value >= 1000000 || value <= -1000000) {
              return `£${(value/1000000).toFixed(1)}M`;
          } else if (value >= 1000 || value <= -1000) {
              return `£${(value/1000).toFixed(1)}K`;
          } else {
              return `£${value.toFixed(0)}`;
          }
      }
      
      // Render the line chart with enhanced visuals
      function renderMainChart() {
          // Clear previous chart and legend
          d3.select("#mainChart").html("");
          d3.select("#chartLegend").html("");
          
          // Prepare data for chart
          const allYearData = financialYears.map((year, i) => {
              const yearData = { financial_year: year };
              
              // Add metrics values
              Object.keys(metricsData).forEach(metric => {
                  yearData[metric] = metricsData[metric][i];
              });
              
              // Add league and position data
              yearData.position = positionData[i];
              yearData.league = leagueData[i];
              
              // Add revenue if available
              if (revenueData && revenueData[i] !== undefined) {
                  yearData.revenue = revenueData[i];
              }
              
              return yearData;
          });
          
          // Set up dimensions
          const margin = {top: 40, right: 50, bottom: 70, left: 90};
          const chartContainer = document.getElementById('mainChart');
          const width = chartContainer.clientWidth - margin.left - margin.right;
          const height = chartContainer.clientHeight - margin.top - margin.bottom;
          
          // Create SVG container
          const svg = d3.select("#mainChart")
              .append("svg")
              .attr("width", chartContainer.clientWidth)
              .attr("height", chartContainer.clientHeight)
              .append("g")
              .attr("transform", `translate(${margin.left}, ${margin.top})`);
          
          // Add chart background for better visibility
          svg.append("rect")
              .attr("width", width)
              .attr("height", height)
              .attr("fill", "rgba(0, 0, 0, 0.5)")
              .attr("rx", 8)
              .attr("ry", 8);
          
          // Determine data range including all selected metrics
          const selectedMetricsValues = selectedMetrics.flatMap(metric => 
              metricsData[metric].filter(val => val !== null && val !== undefined)
          );
          
          // Calculate min/max with some padding
          let yMin = d3.min(selectedMetricsValues) * 1.1;
          let yMax = d3.max(selectedMetricsValues) * 1.1;
          
          // If all values are positive, include zero
          if (yMin > 0) yMin = 0;
          // If all values are negative, include zero
          if (yMax < 0) yMax = 0;
          
          // Set up scales
          const x = d3.scaleLinear()
              .domain([d3.min(financialYears), d3.max(financialYears)])
              .range([0, width])
              .nice();
          
          const y = d3.scaleLinear()
              .domain([yMin, yMax])
              .range([height, 0])
              .nice();
          
          // Improve grid lines - make them much more visible
          svg.selectAll("line.horizontal-grid")
              .data(y.ticks(10))
              .enter()
              .append("line")
              .attr("class", "horizontal-grid")
              .attr("x1", 0)
              .attr("x2", width)
              .attr("y1", d => y(d))
              .attr("y2", d => y(d))
              .style("stroke", "var(--grid)")
              .style("stroke-width", "1px")
              .style("stroke-opacity", "0.8")
              .style("stroke-dasharray", "2,3");
          
          // Add zero line if range crosses zero
          if (yMin < 0 && yMax > 0) {
              svg.append("line")
                  .attr("class", "zero-line")
                  .attr("x1", 0)
                  .attr("x2", width)
                  .attr("y1", y(0))
                  .attr("y2", y(0));
          }
          
          // Add vertical grid lines with better visibility
          svg.selectAll("line.vertical-grid")
              .data(financialYears)
              .enter()
              .append("line")
              .attr("class", "vertical-grid")
              .attr("x1", d => x(d))
              .attr("x2", d => x(d))
              .attr("y1", 0)
              .attr("y2", height)
              .style("stroke", "var(--grid)")
              .style("stroke-width", "1px")
              .style("stroke-opacity", "0.8")
              .style("stroke-dasharray", "2,3");
          
          // Add X axis
          svg.append("g")
              .attr("class", "axis-x")
              .attr("transform", `translate(0, ${height})`)
              .call(d3.axisBottom(x)
                  .tickFormat(d3.format("d"))
                  .ticks(financialYears.length)
                  .tickValues(financialYears))
              .selectAll("text")
                  .style("font-weight", "bold")
                  .style("font-size", "12px");
          
          // Add Y axis
          svg.append("g")
              .attr("class", "axis-y")
              .call(d3.axisLeft(y)
                  .tickFormat(d => {
                      if (d >= 1000000000 || d <= -1000000000) {
                          return `£${(d/1000000000).toFixed(1)}B`;
                      } else {
                          return `£${(d/1000000).toFixed(0)}M`;
                      }
                  })
                  .ticks(10))
              .selectAll("text")
                  .style("font-weight", "bold")
                  .style("font-size", "12px");
          
          // Add axis labels
          svg.append("text")
              .attr("class", "axis-title")
              .attr("x", width / 2)
              .attr("y", height + margin.bottom - 15)
              .attr("text-anchor", "middle")
              .style("fill", "var(--text)")
              .style("font-size", "14px")
              .style("font-weight", "bold")
              .text("Financial Year");
          
          svg.append("text")
              .attr("class", "axis-title")
              .attr("transform", "rotate(-90)")
              .attr("x", -height / 2)
              .attr("y", -margin.left + 20)
              .attr("text-anchor", "middle")
              .style("fill", "var(--text)")
              .style("font-size", "14px")
              .style("font-weight", "bold")
              .text("Amount (GBP)");
          
          // Create line generator
          const line = d3.line()
              .defined(d => d[1] !== null && d[1] !== undefined)
              .x(d => x(d[0]))
              .y(d => y(d[1]))
              .curve(d3.curveCatmullRom.alpha(0.5));
          
          // Draw lines for each selected metric
          selectedMetrics.forEach(metric => {
              // Filter out null values
              const metricData = financialYears.map((year, i) => [year, metricsData[metric][i]])
                  .filter(d => d[1] !== null && d[1] !== undefined);
              
              if (metricData.length > 0) {
                  // Add the line
                  svg.append("path")
                      .datum(metricData)
                      .attr("class", `line line-${metric}`)
                      .attr("d", line)
                      .attr("fill", "none")
                      .attr("stroke", metricsConfig[metric].color)
                      .attr("stroke-width", 3)
                      .attr("opacity", 0.85);
                  
                  // Add data points
                  svg.selectAll(`.dot-${metric}`)
                      .data(metricData)
                      .enter()
                      .append("circle")
                      .attr("class", `dot-${metric}`)
                      .attr("cx", d => x(d[0]))
                      .attr("cy", d => y(d[1]))
                      .attr("r", 5)
                      .attr("fill", metricsConfig[metric].color)
                      .attr("stroke", "#000")
                      .attr("stroke-width", 1);
              }
          });
          
          // Add vertical line guide (initially hidden)
          const verticalGuide = svg.append("line")
              .attr("class", "vertical-guide")
              .attr("y1", 0)
              .attr("y2", height)
              .style("opacity", 0);
          
          // Add interactive overlay for tooltips
          svg.append("rect")
              .attr("class", "overlay")
              .attr("width", width)
              .attr("height", height)
              .style("fill", "none")
              .style("pointer-events", "all")
              .on("mousemove", function(event) {
                  const mouseX = d3.pointer(event)[0];
                  const x0 = x.invert(mouseX);
                  
                  // Find closest year
                  const yearIndex = d3.bisector(d => d.financial_year).left(allYearData, x0);
                  const d = allYearData[Math.min(allYearData.length - 1, yearIndex)];
                  
                  // Show vertical guide
                  verticalGuide
                      .attr("x1", x(d.financial_year))
                      .attr("x2", x(d.financial_year))
                      .style("opacity", 1);
                  
                  // Format tooltip content
                  let tooltipContent = `
                      <div class="tooltip-header">
                          <div class="tooltip-title">Financial Year: ${d.financial_year}</div>
                          ${d.league && d.position ? `<div class="tooltip-subtitle">${d.position} in ${d.league}</div>` : ''}
                      </div>
                      <div class="tooltip-divider"></div>`;
                  
                  // Add each selected metric to tooltip
                  selectedMetrics.forEach(metric => {
                      if (d[metric] !== null && d[metric] !== undefined) {
                          tooltipContent += `
                          <div class="tooltip-item">
                              <span>${metricsConfig[metric].label}:</span>
                              <span class="tooltip-item-value" style="color: ${metricsConfig[metric].color};">${formatCurrency(d[metric])}</span>
                          </div>`;
                      }
                  });
                  
                  // Get container bounds for better tooltip positioning
                  const containerRect = document.querySelector('.container').getBoundingClientRect();
                  const tooltipWidth = window.innerWidth <= 480 ? 240 : 300;
                  const tooltipHeight = 150; // Approximate height, adjust as needed
                  
                  // Calculate initial position
                  let xPosition = event.clientX + 15;
                  let yPosition = event.clientY - 20;
                  
                  // Check right boundary
                  if (xPosition + tooltipWidth > containerRect.right) {
                      xPosition = event.clientX - tooltipWidth - 10;
                  }
                  
                  // Check left boundary
                  if (xPosition < containerRect.left) {
                      xPosition = containerRect.left + 10;
                  }
                  
                  // Check bottom boundary
                  if (yPosition + tooltipHeight > containerRect.bottom) {
                      yPosition = event.clientY - tooltipHeight - 10;
                  }
                  
                  // Check top boundary
                  if (yPosition < containerRect.top) {
                      yPosition = containerRect.top + 10;
                  }
                  
                  // Position and show tooltip with improved positioning
                  d3.select("#tooltip")
                      .style("opacity", 1)
                      .style("left", xPosition + "px")
                      .style("top", yPosition + "px")
                      .html(tooltipContent);
                  
                  // Highlight data points
                  selectedMetrics.forEach(metric => {
                      svg.selectAll(`.dot-${metric}`)
                          .attr("r", d => d[0] === d.financial_year ? 7 : 5)
                          .attr("opacity", d => d[0] === d.financial_year ? 1 : 0.85);
                  });
              })
              .on("mouseout", function() {
                  // Hide tooltip and reset
                  d3.select("#tooltip").style("opacity", 0);
                  verticalGuide.style("opacity", 0);
                  
                  // Reset all data points
                  selectedMetrics.forEach(metric => {
                      svg.selectAll(`.dot-${metric}`)
                          .attr("r", 5)
                          .attr("opacity", 0.85);
                  });
              });
          
          // Create complete legend with all metrics (active and inactive)
          const legend = d3.select("#chartLegend");
          
          allMetrics.forEach(metric => {
              const isActive = selectedMetrics.includes(metric);
              
              const legendItem = legend.append("div")
                  .attr("class", `legend-item ${isActive ? '' : 'inactive'}`)
                  .attr("data-metric", metric)
                  .on("click", function() {
                      // Toggle checkbox when legend item is clicked
                      const checkbox = document.getElementById(metric);
                      checkbox.checked = !checkbox.checked;
                      
                      // Trigger change event
                      const event = new Event('change');
                      checkbox.dispatchEvent(event);
                  });
              
              legendItem.append("div")
                  .attr("class", "legend-color")
                  .style("background-color", metricsConfig[metric].color);
              
              legendItem.append("span")
                  .attr("class", "legend-label")
                  .text(metricsConfig[metric].label);
              
              // Add tooltip with definition
              legendItem.append("div")
                  .attr("class", "legend-tooltip")
                  .html(`
                      <div class="legend-tooltip-title">${metricsConfig[metric].label}</div>
                      <div>${metricsConfig[metric].description}</div>
                  `);
          });
      }
      
      // Metric checkboxes with improved user feedback
      Object.keys(metricsConfig).forEach(metric => {
          const checkbox = document.getElementById(metric);
          if (!checkbox) return; // Skip if checkbox doesn't exist
          
          checkbox.addEventListener("change", function() {
              // Update selected metrics based on checkbox state
              if (this.checked) {
                  selectedMetrics.push(metric);
              } else {
                  selectedMetrics = selectedMetrics.filter(m => m !== metric);
              }
              
              // Prevent deselecting all metrics
              if (selectedMetrics.length === 0) {
                  this.checked = true;
                  selectedMetrics = [metric];
                  
                  // Visual feedback
                  const checkboxLabel = this.nextElementSibling;
                  checkboxLabel.style.color = "var(--primary)";
                  setTimeout(() => {
                      checkboxLabel.style.color = "";
                  }, 1000);
              }
              
              // Re-render chart
              renderMainChart();
          });
      });
      
      // Initialize chart on load and handle window resize with debounce
      let resizeTimer;
      function handleResize() {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(renderMainChart, 250);
      }
      
      // Initialize when window is loaded to ensure all elements have dimensions
      window.onload = function() {
          renderMainChart();
      };
      
      window.addEventListener("resize", handleResize);
    </script>
</body>
</html>