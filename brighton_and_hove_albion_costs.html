
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Club Costs Analysis</title>
    <!-- Load Aglet Sans from Typekit -->
    <link href="https://use.typekit.net/xxs6huv.css" rel="stylesheet">
    <!-- Add Open Sans as fallback from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      :root {
        /* Kinnaird color scheme enhanced */
        --background: #11242B;
        --text: #FFFFFF;
        --muted-text: #CCCCCC;
        --primary: #05D4BE;
        --primary-light: rgba(5, 212, 190, 0.2);
        --primary-dark: #04A599;
        --secondary: #5F84FB;
        --secondary-light: rgba(95, 132, 251, 0.2);
        --accent: #FF9500;
        --accent-light: rgba(255, 149, 0, 0.2);
        --grid: rgba(255, 255, 255, 0.1);
        --line: rgba(255, 255, 255, 0.3);
        --tooltip-bg: #1D3B48;
        --card-bg: rgba(29, 59, 72, 0.4);
        --highlight: rgba(5, 212, 190, 0.1);
      }
      
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
          font-family: 'aglet-sans', 'Open Sans', sans-serif;
          background-color: var(--background);
          color: var(--text);
          margin: 0;
          padding: 0;
          line-height: 1.5;
          font-size: 16px;
      }
      
      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 30px 20px;
      }
      
      .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding-bottom: 20px;
          margin-bottom: 30px;
          border-bottom: 2px solid var(--primary);
      }
      
      .club-info {
          display: flex;
          flex-direction: column;
      }
      
      .club-name {
          font-size: 2rem;
          font-weight: 700;
          color: var(--primary);
          margin-bottom: 5px;
          letter-spacing: -0.5px;
      }
      
      .financial-details {
          font-size: 1.1rem;
          color: var(--muted-text);
          margin-top: 5px;
      }
      
      .controls {
          display: flex;
          flex-wrap: wrap;
          gap: 20px;
          align-items: flex-start;
          margin-bottom: 30px;
          padding: 20px;
          background-color: var(--card-bg);
          border-radius: 12px;
          border: 1px solid rgba(5, 212, 190, 0.2);
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      
      .control-group {
          display: flex;
          flex-direction: column;
          gap: 15px;
      }
      
      .toggle-wrapper {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 8px;
          border-radius: 8px;
          transition: background-color 0.2s;
      }
      
      .toggle-wrapper:hover {
          background-color: var(--highlight);
      }
      
      .toggle-wrapper span {
          font-weight: 600;
      }
      
      .toggle-switch {
          position: relative;
          display: inline-block;
          width: 52px;
          height: 26px;
      }
      
      .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
      }
      
      .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(255, 255, 255, 0.15);
          transition: .3s;
          border-radius: 34px;
          box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      
      .slider:before {
          position: absolute;
          content: "";
          height: 18px;
          width: 18px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .3s;
          border-radius: 50%;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      
      input:checked + .slider {
          background-color: var(--primary);
      }
      
      input:focus + .slider {
          box-shadow: 0 0 1px var(--primary);
      }
      
      input:checked + .slider:before {
          transform: translateX(26px);
      }
      
      /* Enhanced checkbox group styles */
      .group-box {
          border: 1px solid rgba(5, 212, 190, 0.3);
          padding: 15px;
          border-radius: 10px;
          background-color: rgba(5, 212, 190, 0.05);
          min-width: 220px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .group-box:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      
      .group-title {
          font-size: 1.1rem;
          font-weight: bold;
          margin-bottom: 12px;
          color: var(--primary);
          border-bottom: 1px solid rgba(5, 212, 190, 0.2);
          padding-bottom: 8px;
      }
      
      .cost-checkbox {
          margin-bottom: 8px;
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 4px 8px;
          border-radius: 4px;
          transition: background-color 0.2s;
      }
      
      .cost-checkbox:hover {
          background-color: rgba(5, 212, 190, 0.1);
      }
      
      .cost-checkbox label {
          cursor: pointer;
          user-select: none;
      }
      
      .cost-checkbox input[type="checkbox"] {
          cursor: pointer;
          appearance: none;
          -webkit-appearance: none;
          width: 18px;
          height: 18px;
          border: 2px solid var(--primary);
          border-radius: 4px;
          outline: none;
          transition: all 0.2s;
          position: relative;
          background-color: rgba(255, 255, 255, 0.05);
      }
      
      .cost-checkbox input[type="checkbox"]:checked {
          background-color: var(--primary);
      }
      
      .cost-checkbox input[type="checkbox"]:checked::after {
          content: "";
          position: absolute;
          left: 5px;
          top: 2px;
          width: 5px;
          height: 10px;
          border: solid white;
          border-width: 0 2px 2px 0;
          transform: rotate(45deg);
      }
      
      .chart-wrapper {
          background-color: var(--card-bg);
          border-radius: 12px;
          padding: 25px;
          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
          border: 1px solid rgba(5, 212, 190, 0.3);
          margin-bottom: 30px;
          transition: transform 0.3s, box-shadow 0.3s;
      }
      
      .chart-wrapper:hover {
          transform: translateY(-3px);
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      }
      
      .chart-title {
          font-size: 1.4rem;
          margin-bottom: 15px;
          color: var(--primary);
          border-bottom: 1px solid rgba(5, 212, 190, 0.3);
          padding-bottom: 10px;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 10px;
      }
      
      .chart-title::before {
          content: "ðŸ“Š";
          font-size: 1.6rem;
      }
      
      #mainChart {
          transition: opacity 0.5s;
      }
      
      svg text {
          font-family: 'aglet-sans', 'Open Sans', sans-serif;
          fill: var(--text);
      }
      
      .axis-x path, .axis-y path {
          stroke: var(--line);
          stroke-width: 1.5;
      }
      
      .axis-x .tick line, .axis-y .tick line {
          stroke: var(--grid);
          stroke-dasharray: 2,2;
      }
      
      .axis-x text, .axis-y text {
          fill: var(--text);
          font-size: 12px;
          font-weight: 500;
      }
      
      .tooltip {
          position: absolute;
          padding: 12px 15px;
          background: var(--tooltip-bg);
          color: var(--text);
          border: 1px solid var(--primary);
          border-radius: 8px;
          pointer-events: none;
          font-family: 'aglet-sans', 'Open Sans', sans-serif;
          font-size: 14px;
          opacity: 0;
          transition: all 0.3s;
          z-index: 10;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
          max-width: 300px;
          backdrop-filter: blur(4px);
      }
      
      .tooltip-title {
          font-weight: bold;
          color: var(--primary);
          margin-bottom: 8px;
          font-size: 16px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.2);
          padding-bottom: 5px;
      }
      
      .tooltip-item {
          display: flex;
          justify-content: space-between;
          margin-bottom: 4px;
      }
      
      .tooltip-item-value {
          font-weight: bold;
          color: var(--primary);
          margin-left: 15px;
      }
      
      .tooltip-total {
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid rgba(255, 255, 255, 0.2);
          font-weight: bold;
          display: flex;
          justify-content: space-between;
      }
      
      .tooltip-total-value {
          color: var(--primary);
      }
      
      .legend {
          display: flex;
          flex-wrap: wrap;
          gap: 15px;
          margin-top: 20px;
          padding: 15px;
          background-color: rgba(0, 0, 0, 0.2);
          border-radius: 8px;
          border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .legend-item {
          display: flex;
          align-items: center;
          gap: 8px;
          cursor: pointer;
          padding: 6px 12px;
          border-radius: 6px;
          transition: background-color 0.2s, transform 0.2s;
          user-select: none;
      }
      
      .legend-item:hover {
          background-color: rgba(255, 255, 255, 0.1);
          transform: translateY(-2px);
      }
      
      .legend-item.inactive {
          opacity: 0.5;
      }
      
      .legend-color {
          width: 16px;
          height: 16px;
          border-radius: 4px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      
      .legend-label {
          font-weight: 500;
      }
      
      /* Added responsive design */
      @media (max-width: 768px) {
          .container {
              padding: 15px 10px;
          }
          
          .club-name {
              font-size: 1.5rem;
          }
          
          .controls {
              flex-direction: column;
              padding: 15px;
          }
          
          .group-box {
              width: 100%;
          }
          
          .chart-wrapper {
              padding: 15px;
          }
          
          .chart-title {
              font-size: 1.2rem;
          }
      }
      
      /* Animations */
      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }
      
      .container {
          animation: fadeIn 0.5s ease-out;
      }
      
      /* CSS for interactive vertical guide */
      .vertical-guide {
          pointer-events: none;
          stroke: var(--primary);
          stroke-width: 1.5;
          stroke-dasharray: 5,3;
      }
      
      .guide-circle {
          pointer-events: none;
          fill: var(--primary);
          stroke: white;
          stroke-width: 1.5;
      }
      
      /* Add smooth transitions to the chart */
      .layer {
          transition: opacity 0.3s;
      }
      
      /* Add styling for the footer */
      .footer {
          text-align: center;
          margin-top: 40px;
          padding-top: 20px;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
          color: var(--muted-text);
          font-size: 0.9rem;
      }
      
      .footer a {
          color: var(--primary);
          text-decoration: none;
      }
      
      .footer a:hover {
          text-decoration: underline;
      }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="club-info">
                <div class="club-name">Brighton and Hove Albion</div>
                <div class="financial-details">Costs Analysis | 2020 - 2024</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <div class="toggle-wrapper">
                    <label class="toggle-switch">
                        <input type="checkbox" id="inflationToggle">
                        <span class="slider"></span>
                    </label>
                    <span>Adjust for Inflation (2024 Values)</span>
                </div>
            </div>
            <div class="control-group" id="costSelections">
                <div class="group-box">
                    <div class="group-title">Operating Expenses</div>
                    <div class="cost-checkbox">
                        <input type="checkbox" id="staff_costs" checked>
                        <label for="staff_costs">Staff Costs</label>
                    </div>
                    <div class="cost-checkbox">
                        <input type="checkbox" id="operating_expenses" checked>
                        <label for="operating_expenses">Other Operating Expenses</label>
                    </div>
                </div>
                <div class="group-box">
                    <div class="group-title">Non-Cash Flow Expenses</div>
                    <div class="cost-checkbox">
                        <input type="checkbox" id="player_amortisation">
                        <label for="player_amortisation">Player Amortisation</label>
                    </div>
                    <div class="cost-checkbox">
                        <input type="checkbox" id="depreciation">
                        <label for="depreciation">Depreciation</label>
                    </div>
                    <div class="cost-checkbox">
                        <input type="checkbox" id="player_impairment">
                        <label for="player_impairment">Player Impairment</label>
                    </div>
                    <div class="cost-checkbox">
                        <input type="checkbox" id="exceptional_items">
                        <label for="exceptional_items">Exceptional Items</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-wrapper">
            <div class="chart-title">Cost Structure Evolution</div>
            <div id="mainChart" style="width: 100%; height: 500px;"></div>
            <div class="legend" id="chartLegend"></div>
        </div>
        
        <div class="footer">
            <p>Data sourced from financial reports | Visualization by Kinnaird Analytics</p>
        </div>
    </div>
    
    <div id="tooltip" class="tooltip"></div>
    
    <script>
      // Data for the chart
      const clubName = "Brighton and Hove Albion";
      const financialYears = [2020, 2021, 2022, 2023, 2024];
      const costData = {"staff_costs": [103178000.0, 108884000.0, 115264000.0, 0.0, 0.0], "operating_expenses": [187418000.0, 200100000.0, 211576000.0, 214506000.0, 255215000.0], "player_amortisation": [45616000.0, 46400000.0, 45438000.0, 32772000.0, 39374000.0], "depreciation": [5822000.0, 6181000.0, 7765000.0, 7298000.0, 8231000.0], "player_impairment": [0.0, 9370000.0, 8069000.0, 0.0, 2784000.0], "exceptional_items": [0.0, 0.0, 0.0, 0.0, 0.0]};
      const adjustedCostData = {"staff_costs": [128972500.0, 130660800.0, 132553599.99999999, 0.0, 0.0], "operating_expenses": [234272500.0, 240120000.0, 243312399.99999997, 235956600.00000003, 255215000.0], "player_amortisation": [57020000.0, 55680000.0, 52253699.99999999, 36049200.0, 39374000.0], "depreciation": [7277500.0, 7417200.0, 8929750.0, 8027800.000000001, 8231000.0], "player_impairment": [0.0, 11244000.0, 9279350.0, 0.0, 2784000.0], "exceptional_items": [0.0, 0.0, 0.0, 0.0, 0.0]};
      const positionData = ["15th", "16th", "9th", "6th", "11th"];
      const leagueData = ["Premier League", "Premier League", "Premier League", "Premier League", "Premier League"];
      
      // Cost categories (keys remain the same)
      const costCategories = [
        'staff_costs', 
        'operating_expenses', 
        'player_amortisation', 
        'depreciation', 
        'player_impairment', 
        'exceptional_items'
      ];
      
      // Mapping for display labels
      const displayLabels = {
          staff_costs: "Staff Costs",
          operating_expenses: "Other Operating Expenses",
          player_amortisation: "Player Amortisation",
          depreciation: "Depreciation",
          player_impairment: "Player Impairment",
          exceptional_items: "Exceptional Items"
      };
      
      // Enhanced color palette with better contrast and aligned to Kinnaird theme
      const colorPalette = [
        '#05D4BE',  // Staff Costs (primary teal)
        '#5F84FB',  // Other Operating Expenses (secondary blue)
        '#FF9500',  // Player Amortisation (accent orange)
        '#4CD964',  // Depreciation (green)
        '#FF3B30',  // Player Impairment (red)
        '#9C68F5'   // Exceptional Items (purple)
      ];
      
      // Active dataset and selected cost categories for stacking
      let activeWagesData = costData;
      let selectedCategories = ['staff_costs', 'operating_expenses'];
      
      // Render the stacked area chart with enhanced visuals
      function renderMainChart() {
          // Clear previous chart and legend with a fade-out effect
          const chartDiv = document.getElementById('mainChart');
          chartDiv.style.opacity = 0;
          
          setTimeout(() => {
              // Clear the chart and legend
              d3.select("#mainChart").html("");
              d3.select("#chartLegend").html("");
              
              // Prepare data for stacking
              const dataForStack = financialYears.map((year, i) => {
                  let obj = { financial_year: year };
                  
                  // Add each selected category
                  selectedCategories.forEach(category => {
                      obj[category] = activeWagesData[category][i];
                  });
                  
                  // Calculate total for the year
                  obj.total = selectedCategories.reduce((sum, cat) => sum + activeWagesData[cat][i], 0);
                  
                  // Add league and position data
                  obj.league = leagueData[i];
                  obj.position = positionData[i];
                  
                  return obj;
              });
              
              // Create stack layout
              const stack = d3.stack()
                  .keys(selectedCategories)
                  .order(d3.stackOrderNone)
                  .offset(d3.stackOffsetNone);
                  
              const series = stack(dataForStack);
              
              // Compute maximum y value from stacked data with some margin
              const maxY = d3.max(series, s => d3.max(s, d => d[1]));
              
              // Set up dimensions with better margins
              const margin = {top: 40, right: 50, bottom: 70, left: 80};
              const width = document.getElementById('mainChart').clientWidth - margin.left - margin.right;
              const height = document.getElementById('mainChart').clientHeight - margin.top - margin.bottom;
              
              // Create SVG container with a better structure
              const svg = d3.select("#mainChart")
                  .append("svg")
                  .attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                  .attr("transform", `translate(${margin.left}, ${margin.top})`);
              
              // Add chart background for better visibility
              svg.append("rect")
                  .attr("width", width)
                  .attr("height", height)
                  .attr("fill", "rgba(0, 0, 0, 0.1)")
                  .attr("rx", 8)
                  .attr("ry", 8);
              
              // Set up scales with better domain/range
              const x = d3.scaleLinear()
                  .domain([d3.min(financialYears), d3.max(financialYears)])
                  .range([0, width])
                  .nice();
              
              const y = d3.scaleLinear()
                  .domain([0, maxY * 1.1]) // Add 10% padding at the top
                  .range([height, 0])
                  .nice();
              
              // Add grid lines with better styling
              svg.append("g")
                  .attr("class", "grid")
                  .attr("transform", `translate(0, ${height})`)
                  .call(d3.axisBottom(x)
                      .tickFormat("")
                      .tickSize(-height)
                      .tickValues(financialYears));
              
              svg.append("g")
                  .attr("class", "grid")
                  .call(d3.axisLeft(y)
                      .tickFormat("")
                      .tickSize(-width)
                      .ticks(10));
              
              svg.selectAll(".grid line")
                  .style("stroke", "var(--grid)")
                  .style("stroke-opacity", "0.7")
                  .style("stroke-dasharray", "3,3")
                  .style("shape-rendering", "crispEdges");
              
              svg.selectAll(".grid path")
                  .style("stroke-width", "0");
              
              // Add X axis with better styling
              svg.append("g")
                  .attr("class", "axis-x")
                  .attr("transform", `translate(0, ${height})`)
                  .call(d3.axisBottom(x)
                      .tickFormat(d3.format("d"))
                      .ticks(financialYears.length)
                      .tickValues(financialYears))
                  .selectAll("text")
                      .style("font-weight", "bold")
                      .style("font-size", "12px");
              
              // Add Y axis with better styling and formatting
              svg.append("g")
                  .attr("class", "axis-y")
                  .call(d3.axisLeft(y)
                      .tickFormat(d => {
                          if (d >= 1000000000) {
                              return `Â£${(d/1000000000).toFixed(1)}B`;
                          } else {
                              return `Â£${(d/1000000).toFixed(0)}M`;
                          }
                      })
                      .ticks(10))
                  .selectAll("text")
                      .style("font-weight", "bold")
                      .style("font-size", "12px");
              
              // Create area generator with smoother curve
              const area = d3.area()
                  .x(d => x(d.data.financial_year))
                  .y0(d => y(d[0]))
                  .y1(d => y(d[1]))
                  .curve(d3.curveCatmullRom.alpha(0.5));
              
              // Create a group for the stacked areas
              const layersGroup = svg.append("g")
                  .attr("class", "layers");
                  
              // Render stacked areas with enhanced styling
              layersGroup.selectAll(".layer")
                  .data(series)
                  .enter()
                  .append("path")
                  .attr("class", d => `layer layer-${d.key}`)
                  .attr("d", area)
                  .attr("fill", d => {
                      const idx = costCategories.indexOf(d.key);
                      return colorPalette[idx];
                  })
                  .attr("fill-opacity", 0.85)
                  .attr("stroke", d => {
                      const idx = costCategories.indexOf(d.key);
                      // Slightly darker stroke for definition
                      const color = d3.color(colorPalette[idx]);
                      color.opacity = 1;
                      return color.darker(0.5);
                  })
                  .attr("stroke-width", 1.5)
                  .attr("stroke-linejoin", "round")
                  .style("transition", "opacity 0.3s, transform 0.3s");
              
              // Add vertical line guide (initially hidden)
              const verticalGuide = svg.append("line")
                  .attr("class", "vertical-guide")
                  .attr("y1", 0)
                  .attr("y2", height)
                  .style("opacity", 0);
                  
              // Add data points for each year (series points)
              const seriesPoints = [];
              
              // Create tooltip elements with enhanced content
              const tooltip = d3.select("#tooltip");
              
              // Add overlay for tooltip and interaction
              svg.append("rect")
                  .attr("class", "overlay")
                  .attr("width", width)
                  .attr("height", height)
                  .style("fill", "none")
                  .style("pointer-events", "all")
                  .on("mousemove", function(event) {
                      const mouseX = d3.pointer(event)[0];
                      const x0 = x.invert(mouseX);
                      
                      // Find the closest year
                      const i = d3.bisector(d => d.financial_year).left(dataForStack, x0);
                      let d0 = dataForStack[Math.max(0, i-1)];
                      let d1 = dataForStack[Math.min(dataForStack.length-1, i)];
                      let d = (x0 - d0.financial_year) < (d1.financial_year - x0) ? d0 : d1;
                      
                      // Show the vertical guide
                      verticalGuide
                          .attr("x1", x(d.financial_year))
                          .attr("x2", x(d.financial_year))
                          .style("opacity", 1);
                      
                      // Format tooltip content
                      let tooltipContent = `
                          <div class="tooltip-title">Financial Year: ${d.financial_year}</div>
                      `;
                      
                      // League and position info if available
                      if (d.league && d.position) {
                          tooltipContent += `<div class="tooltip-league">${d.league} - Position: ${d.position}</div>`;
                      }
                      
                      // Add each cost category
                      let yearTotal = 0;
                      selectedCategories.forEach(cat => {
                          if (d[cat] > 0) {
                              yearTotal += d[cat];
                              tooltipContent += `
                                  <div class="tooltip-item">
                                      <span>${displayLabels[cat]}:</span>
                                      <span class="tooltip-item-value">Â£${formatCurrency(d[cat])}</span>
                                  </div>
                              `;
                          }
                      });
                      
                      // Add total
                      tooltipContent += `
                          <div class="tooltip-total">
                              <span>Total:</span>
                              <span class="tooltip-total-value">Â£${formatCurrency(yearTotal)}</span>
                          </div>
                      `;
                      
                      // Position and show the tooltip
                      tooltip
                          .style("opacity", 1)
                          .style("left", (event.pageX + 15) + "px")
                          .style("top", (event.pageY - 20) + "px")
                          .html(tooltipContent);
                          
                      // Highlight the active layers
                      d3.selectAll(".layer").style("opacity", 0.5);
                      selectedCategories.forEach(cat => {
                          d3.select(`.layer-${cat}`).style("opacity", 1);
                      });
                  })
                  .on("mouseout", function() {
                      // Hide tooltip and guide
                      tooltip.style("opacity", 0);
                      verticalGuide.style("opacity", 0);
                      
                      // Reset layer opacity
                      d3.selectAll(".layer").style("opacity", 0.85);
                  });
              
              // Add axis labels with better styling
              svg.append("text")
                  .attr("class", "axis-title")
                  .attr("x", width / 2)
                  .attr("y", height + margin.bottom - 15)
                  .attr("text-anchor", "middle")
                  .style("fill", "var(--text)")
                  .style("font-size", "14px")
                  .style("font-weight", "bold")
                  .text("Financial Year");
              
              svg.append("text")
                  .attr("class", "axis-title")
                  .attr("transform", "rotate(-90)")
                  .attr("x", -height / 2)
                  .attr("y", -margin.left + 30)
                  .attr("text-anchor", "middle")
                  .style("fill", "var(--text)")
                  .style("font-size", "14px")
                  .style("font-weight", "bold")
                  .text("Costs (GBP)");
              
              // Enhanced interactive legend
              const legend = d3.select("#chartLegend");
              
              // Keep track of active/inactive states
              const legendState = {};
              costCategories.forEach(cat => {
                  legendState[cat] = selectedCategories.includes(cat);
              });
              
              costCategories.forEach((category, index) => {
                  const isActive = selectedCategories.includes(category);
                  
                  const legendItem = legend.append("div")
                      .attr("class", `legend-item ${isActive ? '' : 'inactive'}`)
                      .attr("data-category", category)
                      .on("click", function() {
                          // Toggle category selection
                          const checkbox = document.getElementById(category);
                          checkbox.checked = !checkbox.checked;
                          checkbox.dispatchEvent(new Event('change'));
                      });
                  
                  legendItem.append("div")
                      .attr("class", "legend-color")
                      .style("background-color", colorPalette[index]);
                  
                  legendItem.append("span")
                      .attr("class", "legend-label")
                      .text(displayLabels[category]);
              });
              
              // Fade chart back in
              chartDiv.style.opacity = 1;
          }, 300); // Short timeout for the fade effect
      }
      
      // Helper function to format currency values
      function formatCurrency(value) {
          if (value >= 1000000000) {
              return `${(value/1000000000).toFixed(2)}B`;
          } else if (value >= 1000000) {
              return `${(value/1000000).toFixed(1)}M`;
          } else if (value >= 1000) {
              return `${(value/1000).toFixed(1)}K`;
          } else {
              return value.toFixed(0);
          }
      }
      
      // Inflation toggle with transition effect
      document.getElementById("inflationToggle").addEventListener("change", function() {
          activeWagesData = this.checked ? adjustedCostData : costData;
          renderMainChart();
          
          // Update inflation toggle label
          const toggleLabel = this.parentElement.nextElementSibling;
          if (this.checked) {
              toggleLabel.textContent = "Adjust for Inflation (2024 Values)";
              toggleLabel.style.color = "var(--primary)";
          } else {
              toggleLabel.textContent = "Adjust for Inflation (2024 Values)";
              toggleLabel.style.color = "var(--text)";
          }
      });
      
      // Cost category checkboxes with improved user feedback
      costCategories.forEach(category => {
          const checkbox = document.getElementById(category);
          checkbox.addEventListener("change", function() {
              // Update selected categories based on checkbox state
              selectedCategories = costCategories.filter(cat => document.getElementById(cat).checked);
              
              // Handle empty selection - prevent unchecking all
              if (selectedCategories.length === 0) {
                  this.checked = true;
                  selectedCategories = [category];
                  
                  // Visual feedback that at least one category is required
                  const checkboxLabel = this.nextElementSibling;
                  checkboxLabel.style.color = "var(--primary)";
                  setTimeout(() => {
                      checkboxLabel.style.color = "";
                  }, 1000);
              }
              
              // Update legend item visual states
              costCategories.forEach(cat => {
                  const legendItem = document.querySelector(`.legend-item[data-category="${cat}"]`);
                  if (legendItem) {
                      if (selectedCategories.includes(cat)) {
                          legendItem.classList.remove('inactive');
                      } else {
                          legendItem.classList.add('inactive');
                      }
                  }
              });
              
              // Re-render chart
              renderMainChart();
          });
      });
      
      // Initialize chart on load and handle window resize with debounce
      let resizeTimer;
      function handleResize() {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(renderMainChart, 250);
      }
      
      document.addEventListener("DOMContentLoaded", renderMainChart);
      window.addEventListener("resize", handleResize);
    </script>
</body>
</html>
