
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Club Costs Analysis</title>
    <!-- Load Aglet Sans from Typekit -->
    <link href="https://use.typekit.net/xxs6huv.css" rel="stylesheet">
    <!-- Add Open Sans as fallback from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      :root {
        /* Kinnaird color scheme enhanced */
        --background: #11242B;
        --text: #FFFFFF;
        --muted-text: #CCCCCC;
        --primary: #05D4BE;
        --primary-light: rgba(5, 212, 190, 0.2);
        --primary-dark: #04A599;
        --secondary: #5F84FB;
        --secondary-light: rgba(95, 132, 251, 0.2);
        --accent: #FF9500;
        --accent-light: rgba(255, 149, 0, 0.2);
        --grid: rgba(255, 255, 255, 0.1);
        --line: rgba(255, 255, 255, 0.3);
        --tooltip-bg: #1D3B48;
        --card-bg: rgba(29, 59, 72, 0.4);
        --highlight: rgba(5, 212, 190, 0.1);
      }
      
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
          font-family: 'aglet-sans', 'Open Sans', sans-serif;
          background-color: var(--background);
          color: var(--text);
          margin: 0;
          padding: 0;
          line-height: 1.5;
          font-size: 16px;
      }
      
      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 30px 20px;
      }
      
      .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding-bottom: 20px;
          margin-bottom: 30px;
          border-bottom: 2px solid var(--primary);
      }
      
      .club-info {
          display: flex;
          flex-direction: column;
      }
      
      .financial-details {
          font-size: 1.1rem;
          color: var(--muted-text);
          margin-top: 5px;
      }
      
      .controls {
          display: flex;
          flex-direction: column;
          gap: 15px;
          margin-bottom: 30px;
          padding: 20px;
          background-color: var(--card-bg);
          border-radius: 12px;
          border: 1px solid rgba(5, 212, 190, 0.2);
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      
      .control-group {
          display: flex;
          align-items: center;
          gap: 15px;
      }
      
      /* Horizontal checkbox layout */
      .checkbox-container {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          width: 100%;
          margin-top: 5px;
      }
      
      .category-group {
          margin-right: 10px;
      }
      
      .group-title {
          font-size: 1rem;
          font-weight: bold;
          color: var(--primary);
          margin-bottom: 8px;
          padding-bottom: 4px;
          border-bottom: 1px solid rgba(5, 212, 190, 0.2);
      }
      
      .cost-checkbox {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 6px 12px;
          margin-right: 8px;
          border-radius: 6px;
          transition: all 0.2s;
          border: 1px solid rgba(5, 212, 190, 0.2);
          background-color: rgba(5, 212, 190, 0.05);
      }
      
      .cost-checkbox:hover {
          background-color: rgba(5, 212, 190, 0.15);
          transform: translateY(-2px);
          box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      }
      
      .cost-checkbox label {
          cursor: pointer;
          user-select: none;
          font-weight: 500;
      }
      
      .cost-checkbox input[type="checkbox"] {
          cursor: pointer;
          appearance: none;
          -webkit-appearance: none;
          width: 18px;
          height: 18px;
          border: 2px solid var(--primary);
          border-radius: 4px;
          outline: none;
          transition: all 0.2s;
          position: relative;
          background-color: rgba(255, 255, 255, 0.05);
      }
      
      .cost-checkbox input[type="checkbox"]:checked {
          background-color: var(--primary);
      }
      
      .cost-checkbox input[type="checkbox"]:checked + label {
          color: var(--primary);
      }
      
      .chart-wrapper {
          background-color: var(--card-bg);
          border-radius: 12px;
          padding: 25px;
          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
          border: 1px solid rgba(5, 212, 190, 0.3);
          margin-bottom: 30px;
          transition: transform 0.3s, box-shadow 0.3s;
      }
      
      .chart-wrapper:hover {
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      }
      
      .chart-title {
          font-size: 1.4rem;
          margin-bottom: 15px;
          color: var(--primary);
          border-bottom: 1px solid rgba(5, 212, 190, 0.3);
          padding-bottom: 10px;
          font-weight: 600;
      }
      
      #mainChart {
          width: 100%;
          height: 500px;
          background-color: rgba(0, 0, 0, 0.05);
          border-radius: 8px;
      }
      
      svg text {
          font-family: 'aglet-sans', 'Open Sans', sans-serif;
          fill: var(--text);
      }
      
      .axis-x path, .axis-y path {
          stroke: var(--line);
          stroke-width: 1.5;
      }
      
      .axis-x .tick line, .axis-y .tick line {
          stroke: var(--grid);
          stroke-dasharray: 2,2;
      }
      
      .axis-x text, .axis-y text {
          fill: var(--text);
          font-size: 12px;
          font-weight: 500;
      }
      
      .tooltip {
          position: absolute;
          padding: 12px 15px;
          background: var(--tooltip-bg);
          color: var(--text);
          border: 1px solid var(--primary);
          border-radius: 8px;
          pointer-events: none;
          font-family: 'aglet-sans', 'Open Sans', sans-serif;
          font-size: 14px;
          opacity: 0;
          transition: all 0.3s;
          z-index: 10;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
          max-width: 300px;
          backdrop-filter: blur(4px);
      }
      
      .tooltip-header {
          margin-bottom: 5px;
      }
      
      .tooltip-title {
          font-weight: bold;
          color: var(--primary);
          margin-bottom: 4px;
          font-size: 16px;
      }
      
      .tooltip-subtitle {
          color: var(--muted-text);
          font-size: 13px;
          margin-bottom: 8px;
      }
      
      .tooltip-divider {
          height: 1px;
          background-color: rgba(255, 255, 255, 0.2);
          margin: 8px 0;
          width: 100%;
      }
      
      .tooltip-item {
          display: flex;
          justify-content: space-between;
          margin-bottom: 4px;
      }
      
      .tooltip-item-value {
          font-weight: bold;
          color: var(--primary);
          margin-left: 15px;
      }
      
      .tooltip-total {
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid rgba(255, 255, 255, 0.2);
          font-weight: bold;
          display: flex;
          justify-content: space-between;
      }
      
      .tooltip-total-value {
          color: var(--primary);
      }
      
      .legend {
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
          margin-top: 20px;
          padding: 15px;
          background-color: rgba(0, 0, 0, 0.2);
          border-radius: 8px;
          border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .legend-item {
          display: flex;
          align-items: center;
          gap: 8px;
          cursor: help;
          padding: 6px 12px;
          border-radius: 6px;
          transition: all 0.2s;
          user-select: none;
          position: relative;
      }
      
      .legend-item:hover {
          background-color: rgba(255, 255, 255, 0.1);
          transform: translateY(-2px);
      }
      
      .legend-color {
          width: 16px;
          height: 16px;
          border-radius: 4px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      
      .legend-label {
          font-weight: 500;
      }
      
      .legend-tooltip {
          position: absolute;
          bottom: 100%;
          left: 50%;
          transform: translateX(-50%);
          min-width: 200px;
          max-width: 250px;
          background-color: var(--tooltip-bg);
          color: var(--text);
          padding: 10px 12px;
          border-radius: 6px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          border: 1px solid var(--primary);
          z-index: 100;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s;
          font-size: 0.9rem;
          margin-bottom: 10px;
      }
      
      .legend-tooltip::after {
          content: "";
          position: absolute;
          top: 100%;
          left: 50%;
          margin-left: -8px;
          border-width: 8px;
          border-style: solid;
          border-color: var(--primary) transparent transparent transparent;
      }
      
      .legend-item:hover .legend-tooltip {
          opacity: 1;
          visibility: visible;
      }
      
      .legend-tooltip-title {
          font-weight: bold;
          color: var(--primary);
          margin-bottom: 5px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.2);
          padding-bottom: 3px;
      }
      
      /* Added responsive design */
      @media (max-width: 768px) {
          .container {
              padding: 15px 10px;
          }
          
          .financial-details {
              font-size: 1rem;
          }
          
          .controls {
              flex-direction: column;
              padding: 15px;
          }
          
          .chart-wrapper {
              padding: 15px;
          }
          
          .chart-title {
              font-size: 1.2rem;
          }
      }
      
      /* CSS for interactive vertical guide */
      .vertical-guide {
          pointer-events: none;
          stroke: var(--primary);
          stroke-width: 1.5;
          stroke-dasharray: 5,3;
      }
      
      .guide-circle {
          pointer-events: none;
          fill: var(--primary);
          stroke: white;
          stroke-width: 1.5;
      }
      
      /* Add smooth transitions to the chart */
      .layer {
          transition: opacity 0.3s;
      }
      
      /* Add styling for the footer */
      .footer {
          text-align: center;
          margin-top: 40px;
          padding-top: 20px;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
          color: var(--muted-text);
          font-size: 0.9rem;
      }
      
      .footer a {
          color: var(--primary);
          text-decoration: none;
      }
      
      .footer a:hover {
          text-decoration: underline;
      }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="club-info">
                <div class="financial-details">Costs Analysis | 2020 - 2023</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group" id="costSelections">
                <div style="display: flex; justify-content: space-between; width: 100%;">
                    <div style="width: 48%;">
                        <div class="category-group">
                            <div class="group-title">Operating Expenses</div>
                        </div>
                        <div class="checkbox-container">
                            <div class="cost-checkbox">
                                <input type="checkbox" id="staff_costs" checked>
                                <label for="staff_costs">Staff Costs</label>
                            </div>
                        </div>
                        <div class="checkbox-container" style="margin-top: 8px;">
                            <div class="cost-checkbox">
                                <input type="checkbox" id="operating_expenses" checked>
                                <label for="operating_expenses">Other Operating Expenses</label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="width: 48%;">
                        <div class="category-group">
                            <div class="group-title">Non-Operating Expenses</div>
                        </div>
                        <div class="checkbox-container">
                            <div class="cost-checkbox">
                                <input type="checkbox" id="player_amortisation">
                                <label for="player_amortisation">Player Amortisation</label>
                            </div>
                            <div class="cost-checkbox">
                                <input type="checkbox" id="depreciation">
                                <label for="depreciation">Depreciation</label>
                            </div>
                        </div>
                        <div class="checkbox-container" style="margin-top: 8px;">
                            <div class="cost-checkbox">
                                <input type="checkbox" id="player_impairment">
                                <label for="player_impairment">Player Impairment</label>
                            </div>
                            <div class="cost-checkbox">
                                <input type="checkbox" id="exceptional_items">
                                <label for="exceptional_items">Exceptional Items</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-wrapper">
            <div class="chart-title">Cost Structure Evolution</div>
            <div id="mainChart"></div>
            <div class="legend" id="chartLegend"></div>
        </div>
        
        <div class="footer">
            <p>Data sourced from financial reports | Visualization by Kinnaird Analytics</p>
        </div>
    </div>
    
    <div id="tooltip" class="tooltip"></div>
    
    <script>
      // Data for the chart
      const financialYears = [2020, 2021, 2022, 2023];
      const costData = {"staff_costs": [107871000.0, 57376000.0, 61381000.0, 100109000.0], "operating_expenses": [20608000.0, 14286000.0, 17131000.0, 0.0], "player_amortisation": [47170000.0, 35946000.0, 29786000.0, 41226000.0], "depreciation": [1253000.0, 1274000.0, 1242000.0, 1484000.0], "player_impairment": [0.0, 0.0, 0.0, 0.0], "exceptional_items": [0.0, 0.0, 0.0, 71444000.0]};
      const positionData = ["18th", null, null, "15th"];
      const leagueData = ["Premier League", null, null, "Premier League"];
      
      // Cost categories (keys remain the same)
      const costCategories = [
        'staff_costs', 
        'operating_expenses', 
        'player_amortisation', 
        'depreciation', 
        'player_impairment', 
        'exceptional_items'
      ];
      
      // Mapping for display labels
      const displayLabels = {
          staff_costs: "Staff Costs",
          operating_expenses: "Other Operating Expenses",
          player_amortisation: "Player Amortisation",
          depreciation: "Depreciation",
          player_impairment: "Player Impairment",
          exceptional_items: "Exceptional Items"
      };
      
      // Enhanced color palette with better contrast and aligned to Kinnaird theme
      const colorPalette = [
        '#05D4BE',  // Staff Costs (primary teal)
        '#5F84FB',  // Other Operating Expenses (secondary blue)
        '#FF9500',  // Player Amortisation (accent orange)
        '#4CD964',  // Depreciation (green)
        '#FF3B30',  // Player Impairment (red)
        '#9C68F5'   // Exceptional Items (purple)
      ];
      
      // Active dataset and selected cost categories for stacking
      let activeWagesData = costData;
      let selectedCategories = ['staff_costs', 'operating_expenses'];
      
      // Helper function to format currency values
      function formatCurrency(value) {
          if (value >= 1000000000) {
              return `${(value/1000000000).toFixed(2)}B`;
          } else if (value >= 1000000) {
              return `${(value/1000000).toFixed(1)}M`;
          } else if (value >= 1000) {
              return `${(value/1000).toFixed(1)}K`;
          } else {
              return value.toFixed(0);
          }
      }
      
      // Render the stacked area chart with enhanced visuals
      function renderMainChart() {
          // Clear previous chart and legend
          d3.select("#mainChart").html("");
          d3.select("#chartLegend").html("");
          
          // Prepare data for stacking
          const dataForStack = financialYears.map((year, i) => {
              let obj = { financial_year: year };
              
              // Add each selected category
              selectedCategories.forEach(category => {
                  obj[category] = activeWagesData[category][i];
              });
              
              // Calculate total for the year
              obj.total = selectedCategories.reduce((sum, cat) => sum + activeWagesData[cat][i], 0);
              
              // Add league and position data
              obj.league = leagueData[i];
              obj.position = positionData[i];
              
              return obj;
          });
          
          // Create stack layout
          const stack = d3.stack()
              .keys(selectedCategories)
              .order(d3.stackOrderNone)
              .offset(d3.stackOffsetNone);
              
          const series = stack(dataForStack);
          
          // Compute maximum y value from stacked data with some margin
          const maxY = d3.max(series, s => d3.max(s, d => d[1]));
          
          // Set up dimensions with better margins
          const margin = {top: 40, right: 50, bottom: 70, left: 80};
          const chartContainer = document.getElementById('mainChart');
          const width = chartContainer.clientWidth - margin.left - margin.right;
          const height = chartContainer.clientHeight - margin.top - margin.bottom;
          
          // Create SVG container with a better structure
          const svg = d3.select("#mainChart")
              .append("svg")
              .attr("width", chartContainer.clientWidth)
              .attr("height", chartContainer.clientHeight)
              .append("g")
              .attr("transform", `translate(${margin.left}, ${margin.top})`);
          
          // Add chart background for better visibility
          svg.append("rect")
              .attr("width", width)
              .attr("height", height)
              .attr("fill", "rgba(0, 0, 0, 0.1)")
              .attr("rx", 8)
              .attr("ry", 8);
          
          // Set up scales with better domain/range
          const x = d3.scaleLinear()
              .domain([d3.min(financialYears), d3.max(financialYears)])
              .range([0, width])
              .nice();
          
          const y = d3.scaleLinear()
              .domain([0, maxY * 1.1]) // Add 10% padding at the top
              .range([height, 0])
              .nice();
          
          // Add horizontal grid lines with faint styling
          svg.selectAll("line.horizontal-grid")
              .data(y.ticks(10))
              .enter()
              .append("line")
              .attr("class", "horizontal-grid")
              .attr("x1", 0)
              .attr("x2", width)
              .attr("y1", d => y(d))
              .attr("y2", d => y(d))
              .style("stroke", "var(--grid)")
              .style("stroke-opacity", "0.4")
              .style("stroke-dasharray", "2,3");
              
          // Add vertical grid lines
          svg.append("g")
              .attr("class", "grid")
              .attr("transform", `translate(0, ${height})`)
              .call(d3.axisBottom(x)
                  .tickFormat("")
                  .tickSize(-height)
                  .tickValues(financialYears));
          
          svg.selectAll(".grid line")
              .style("stroke", "var(--grid)")
              .style("stroke-opacity", "0.7")
              .style("stroke-dasharray", "3,3")
              .style("shape-rendering", "crispEdges");
          
          svg.selectAll(".grid path")
              .style("stroke-width", "0");
          
          // Add X axis with better styling
          svg.append("g")
              .attr("class", "axis-x")
              .attr("transform", `translate(0, ${height})`)
              .call(d3.axisBottom(x)
                  .tickFormat(d3.format("d"))
                  .ticks(financialYears.length)
                  .tickValues(financialYears))
              .selectAll("text")
                  .style("font-weight", "bold")
                  .style("font-size", "12px");
          
          // Add Y axis with better styling and formatting
          svg.append("g")
              .attr("class", "axis-y")
              .call(d3.axisLeft(y)
                  .tickFormat(d => {
                      if (d >= 1000000000) {
                          return `£${(d/1000000000).toFixed(1)}B`;
                      } else {
                          return `£${(d/1000000).toFixed(0)}M`;
                      }
                  })
                  .ticks(10))
              .selectAll("text")
                  .style("font-weight", "bold")
                  .style("font-size", "12px");
          
          // Create area generator with smoother curve
          const area = d3.area()
              .x(d => x(d.data.financial_year))
              .y0(d => y(d[0]))
              .y1(d => y(d[1]))
              .curve(d3.curveCatmullRom.alpha(0.5));
          
          // Create a group for the stacked areas
          const layersGroup = svg.append("g")
              .attr("class", "layers");
              
          // Render stacked areas with enhanced styling
          layersGroup.selectAll(".layer")
              .data(series)
              .enter()
              .append("path")
              .attr("class", d => `layer layer-${d.key}`)
              .attr("d", area)
              .attr("fill", d => {
                  const idx = costCategories.indexOf(d.key);
                  return colorPalette[idx];
              })
              .attr("fill-opacity", 0.85)
              .attr("stroke", d => {
                  const idx = costCategories.indexOf(d.key);
                  // Slightly darker stroke for definition
                  const color = d3.color(colorPalette[idx]);
                  color.opacity = 1;
                  return color.darker(0.5);
              })
              .attr("stroke-width", 1.5)
              .attr("stroke-linejoin", "round")
              .style("transition", "opacity 0.3s, transform 0.3s");
          
          // Add vertical line guide (initially hidden)
          const verticalGuide = svg.append("line")
              .attr("class", "vertical-guide")
              .attr("y1", 0)
              .attr("y2", height)
              .style("opacity", 0);
          
          // Create tooltip elements with enhanced content
          const tooltip = d3.select("#tooltip");
          
          // Add overlay for tooltip and interaction
          svg.append("rect")
              .attr("class", "overlay")
              .attr("width", width)
              .attr("height", height)
              .style("fill", "none")
              .style("pointer-events", "all")
              .on("mousemove", function(event) {
                  const mouseX = d3.pointer(event)[0];
                  const x0 = x.invert(mouseX);
                  
                  // Find the closest year
                  const i = d3.bisector(d => d.financial_year).left(dataForStack, x0);
                  let d0 = dataForStack[Math.max(0, i-1)];
                  let d1 = dataForStack[Math.min(dataForStack.length-1, i)];
                  let d = (x0 - d0.financial_year) < (d1.financial_year - x0) ? d0 : d1;
                  
                  // Show the vertical guide
                  verticalGuide
                      .attr("x1", x(d.financial_year))
                      .attr("x2", x(d.financial_year))
                      .style("opacity", 1);
                  
                  // Format tooltip content
                  const tooltipContent = `
                      <div class="tooltip-header">
                          <div class="tooltip-title">Financial Year: ${d.financial_year}</div>
                          ${d.league && d.position ? `<div class="tooltip-subtitle">${d.league} - Position: ${d.position}</div>` : ''}
                      </div>
                      <div class="tooltip-divider"></div>
                      ${selectedCategories.map(cat => {
                          if (d[cat] > 0) {
                              return `<div class="tooltip-item">
                                  <span>${displayLabels[cat]}:</span>
                                  <span class="tooltip-item-value">£${formatCurrency(d[cat])}</span>
                              </div>`;
                          }
                          return '';
                      }).join('')}
                      <div class="tooltip-total">
                          <span>Total:</span>
                          <span class="tooltip-total-value">£${formatCurrency(d.total)}</span>
                      </div>
                  `;
                  
                  // Position and show the tooltip
                  tooltip
                      .style("opacity", 1)
                      .style("left", (event.pageX + 15) + "px")
                      .style("top", (event.pageY - 20) + "px")
                      .html(tooltipContent);
                      
                  // Highlight the active layers
                  d3.selectAll(".layer").style("opacity", 0.5);
                  selectedCategories.forEach(cat => {
                      d3.select(`.layer-${cat}`).style("opacity", 1);
                  });
              })
              .on("mouseout", function() {
                  // Hide tooltip and guide
                  tooltip.style("opacity", 0);
                  verticalGuide.style("opacity", 0);
                  
                  // Reset layer opacity
                  d3.selectAll(".layer").style("opacity", 0.85);
              });
          
          // Add axis labels with better styling
          svg.append("text")
              .attr("class", "axis-title")
              .attr("x", width / 2)
              .attr("y", height + margin.bottom - 15)
              .attr("text-anchor", "middle")
              .style("fill", "var(--text)")
              .style("font-size", "14px")
              .style("font-weight", "bold")
              .text("Financial Year");
          
          svg.append("text")
              .attr("class", "axis-title")
              .attr("transform", "rotate(-90)")
              .attr("x", -height / 2)
              .attr("y", -margin.left + 30)
              .attr("text-anchor", "middle")
              .style("fill", "var(--text)")
              .style("font-size", "14px")
              .style("font-weight", "bold")
              .text("Costs (GBP)");
          
          // Enhanced legend with definitions on hover
          const legend = d3.select("#chartLegend");
          
          // Update category definitions to reflect operating vs non-operating split
          const categoryDefinitions = {
              staff_costs: "The total compensation paid to players, coaches, and all club staff including wages, salaries, bonuses, and pension contributions. This is a core operating expense.",
              operating_expenses: "Day-to-day costs like stadium maintenance, match day operations, travel, training facilities, and administrative expenses excluding staff wages. These are essential for the club's regular operations.",
              player_amortisation: "The systematic allocation of player transfer fees over the length of their contracts. This is a non-operating accounting expense that doesn't reflect immediate cash outflows.",
              depreciation: "The systematic allocation of costs for physical assets like stadiums and facilities over their useful life. This is a non-cash accounting expense.",
              player_impairment: "Write-downs in player values when their recoverable value falls below their book value, often due to injuries or performance decline. This is a non-operating expense.",
              exceptional_items: "One-time costs or income that are unusual or infrequent, such as management restructuring, stadium relocation, or legal settlements. These are not part of normal operations."
          };
          
          costCategories.forEach((category, index) => {
              const legendItem = legend.append("div")
                  .attr("class", "legend-item")
                  .attr("data-category", category);
              
              legendItem.append("div")
                  .attr("class", "legend-color")
                  .style("background-color", colorPalette[index]);
              
              legendItem.append("span")
                  .attr("class", "legend-label")
                  .text(displayLabels[category]);
                  
              // Add tooltip with definition
              const tooltip = legendItem.append("div")
                  .attr("class", "legend-tooltip")
                  .html(`
                      <div class="legend-tooltip-title">${displayLabels[category]}</div>
                      <div>${categoryDefinitions[category]}</div>
                  `);
          });
      }
      
      // Cost category checkboxes with improved user feedback
      costCategories.forEach(category => {
          const checkbox = document.getElementById(category);
          checkbox.addEventListener("change", function() {
              // Update selected categories based on checkbox state
              selectedCategories = costCategories.filter(cat => document.getElementById(cat).checked);
              
              // Handle empty selection - prevent unchecking all
              if (selectedCategories.length === 0) {
                  this.checked = true;
                  selectedCategories = [category];
                  
                  // Visual feedback that at least one category is required
                  const checkboxLabel = this.nextElementSibling;
                  checkboxLabel.style.color = "var(--primary)";
                  setTimeout(() => {
                      checkboxLabel.style.color = "";
                  }, 1000);
              }
              
              // Re-render chart
              renderMainChart();
          });
      });
      
      // Initialize chart on load and handle window resize with debounce
      let resizeTimer;
      function handleResize() {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(renderMainChart, 250);
      }
      
      // Initialize when window is loaded to ensure all elements have dimensions
      window.onload = function() {
          renderMainChart();
      };
      
      window.addEventListener("resize", handleResize);
    </script>
</body>
</html>
