<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Newcastle United - Financial Snapshot</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://use.typekit.net/xxs6huv.css" />
    <style>
      body {
        background-color: #000;
        color: white;
        font-family: 'aglet-sans', sans-serif;
        padding: 20px;
        margin: 0;
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #000;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid rgba(5, 212, 190, 0.3);
        padding-bottom: 10px;
      }
      .club-info {
        display: flex;
        flex-direction: column;
      }
      .financial-year {
        font-size: 1.2rem;
        color: #ccc;
      }
      .team-performance {
        font-size: 1rem;
        color: #ccc;
        margin-top: 5px;
      }
      .metrics-cards {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .metric-card {
        background: linear-gradient(135deg, rgba(5, 212, 190, 0.2), rgba(95, 132, 251, 0.2));
        border-radius: 8px;
        padding: 15px;
        flex: 1;
        min-width: 180px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(5, 212, 190, 0.3);
        text-align: center;
      }
      .metric-title {
        font-size: 1rem;
        color: #ccc;
      }
      .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin: 10px 0;
        color: #05d4be;
      }
      .metric-change {
        font-size: 0.9rem;
      }
      .positive-change {
        color: #4cd964;
      }
      .negative-change {
        color: #ff3b30;
      }
      .chart-wrapper {
        background-color: rgba(5, 212, 190, 0.05);
        border-radius: 8px;
        padding: 15px;
        border: 1px solid rgba(5, 212, 190, 0.2);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
      }
      .panel-title {
        font-size: 1.1rem;
        margin-bottom: 10px;
        color: #05d4be;
        border-bottom: 1px solid rgba(5, 212, 190, 0.3);
        padding-bottom: 5px;
      }
      .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }
      .chart-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }
      .metric-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
      }
      .metric-label {
        color: #ccc;
      }
      .tooltip {
        position: absolute;
        padding: 10px;
        background: #1d3b48;
        color: white;
        border: 1px solid #05d4be;
        border-radius: 5px;
        pointer-events: none;
        font-family: 'aglet-sans', sans-serif;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 10;
      }
      .footer {
        text-align: center;
        margin-top: 30px;
        font-size: 0.8rem;
        color: #666;
      }
      @media (max-width: 768px) {
        .metrics-grid, .chart-container {
          grid-template-columns: 1fr;
        }
        .metric-card {
          min-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="club-info">
          <div class="financial-year">Financial Year: 2024</div>
          <div class="team-performance">Team Performance: 7th in Premier League</div>
        </div>
      </div>

      <div class="metrics-cards">
        <div class="metric-card">
          <div class="metric-title">Total Revenue</div>
          <div class="metric-value">£317.5M</div>
          <div class="metric-change"><span class="positive-change">+5.0% vs prev. year</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Wage Bill</div>
          <div class="metric-value">£218.7M</div>
          <div class="metric-change"><span class="negative-change">-2.0% vs prev. year</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Operating Result</div>
          <div class="metric-value">£1.2M</div>
          <div class="metric-change"><span class="positive-change">+10.0% vs prev. year</span></div>
        </div>
      </div>

      <div class="chart-wrapper" style="margin-bottom: 20px;">
        <div class="panel-title">Revenue Breakdown</div>
        <div class="metrics-grid">
          <div>
            <div class="metric-row">
              <span class="metric-label">Matchday</span>
              <span class="metric-value">£50.1M (50%)</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Broadcasting</span>
              <span class="metric-value">£183.8M (25%)</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Commercial</span>
              <span class="metric-value">£83.6M (25%)</span>
            </div>
          </div>
          <div id="revenueChart" style="height: 180px;"></div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-wrapper">
          <div class="panel-title">Revenue Trend</div>
          <div id="revenueTrendChart" style="height: 200px;"></div>
        </div>
        <div class="chart-wrapper">
          <div class="panel-title">Wages Trend</div>
          <div id="wagesTrendChart" style="height: 200px;"></div>
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="panel-title">Operating Profit/Loss Trend</div>
        <div id="profitTrendChart" style="height: 200px;"></div>
      </div>

      <div class="footer">
        Data last updated: 2025-04-09 11:15:57 | Source: Club Accounts &amp; Premier League Financial Records
        <div><small>Double-click on chart area to view data details</small></div>
      </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
      // Data passed from Python
      const clubData = {"team_name": "Newcastle United", "financial_year": 2024, "league": "Premier League", "position_finished": "7th", "matchday_income": 50095000, "broadcast_income": 183785000, "commercial_income": 83573000, "total_income": 317453000, "other_income": 2860000, "staff_costs": 218738000, "operating_expenses": 67671000, "player_amortisation": 96744000, "depreciation": 4962000, "player_impairment": 801000, "exceptional_items": null, "operating_profit_loss": 1213000, "profit_on_player_sales": 69816000, "profit_loss_before_interest_tax": 1213000, "profit_loss_before_tax": -11079000, "profit_loss_after_tax": -11097000, "player_signings": 206113000, "player_sales": 90594000, "net_spend": 115519000, "gross_squad_cost": null, "transfer_debtors": null, "transfer_creditors": null, "cash": 15429000, "borrowing": 49716000, "net_debt": null, "wages_income_percentage": null, "director_pay": null, "total_player_cost": null, "average_weekly_wage": null};
      const historicalData = [{"financial_year": 2024, "total_income": 317453000, "staff_costs": 218738000, "operating_profit_loss": 1213000, "net_debt": null}, {"financial_year": 2023, "total_income": 247314000, "staff_costs": 186679000, "operating_profit_loss": -66457000, "net_debt": null}, {"financial_year": 2022, "total_income": 178185000, "staff_costs": 170204000, "operating_profit_loss": -71664000, "net_debt": null}, {"financial_year": 2021, "total_income": 137015000, "staff_costs": 106829000, "operating_profit_loss": -13717000, "net_debt": null}, {"financial_year": 2020, "total_income": 149396000, "staff_costs": 121146000, "operating_profit_loss": -54022000, "net_debt": null}];
      const leagueAverages = {"avg_income": 357535562.5, "avg_wages": 207832856.9375, "avg_amortisation": 89762586.5, "avg_debt": null, "avg_wages_ratio": 63.925000000000004};

      // Format helpers
      function formatCurrency(value) {
        if (value === null || isNaN(value)) return '?';
        return '£' + (value / 1000000).toFixed(1) + 'M';
      }

      function formatPercentage(value) {
        if (isNaN(value)) return '-';
        return (value > 0 ? '+' : '') + value.toFixed(1) + '%';
      }

      // Create Revenue Breakdown Chart
      function createRevenueChart() {
        const container = document.getElementById("revenueChart");
        const width = container.clientWidth;
        const height = container.clientHeight;
        const margin = { top: 10, right: 10, bottom: 20, left: 40 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const svg = d3
          .select("#revenueChart")
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .append("g")
          .attr("transform", `translate(${margin.left}, ${margin.top})`);

        const revenueData = [
          { category: "Matchday", value: clubData.matchday_income },
          { category: "Broadcast", value: clubData.broadcast_income },
          { category: "Commercial", value: clubData.commercial_income }
        ];

        const filteredData = revenueData.filter((d) => d.value !== null);

        const color = d3
          .scaleOrdinal()
          .domain(filteredData.map((d) => d.category))
          .range(["#5F84FB", "#05D4BE", "#FF9500"]);

        const x = d3.scaleBand().domain(filteredData.map((d) => d.category)).range([0, innerWidth]).padding(0.3);
        const y = d3.scaleLinear().domain([0, d3.max(filteredData, (d) => d.value) * 1.1 || 1]).range([innerHeight, 0]);

        svg
          .selectAll(".bar")
          .data(filteredData)
          .enter()
          .append("rect")
          .attr("class", "bar")
          .attr("x", (d) => x(d.category))
          .attr("y", (d) => y(d.value))
          .attr("width", x.bandwidth())
          .attr("height", (d) => innerHeight - y(d.value))
          .attr("fill", (d) => color(d.category))
          .attr("rx", 3)
          .attr("ry", 3)
          .attr("stroke", "rgba(255, 255, 255, 0.5)")
          .attr("stroke-width", 1)
          .on("mouseover", function(event, d) {
            d3.select(this).attr("stroke-width", 2);
            const percentage = (d.value / clubData.total_income * 100).toFixed(1);
            d3.select("#tooltip")
              .style("opacity", 1)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 15 + "px")
              .html(
                `<strong>$ {d.category}</strong><br>£$ {(d.value/1000000).toFixed(1)}M<br>$ {percentage}% of total revenue`
              );
          })
          .on("mouseout", function() {
            d3.select(this).attr("stroke-width", 1);
            d3.select("#tooltip").style("opacity", 0);
          });

        svg
          .append("g")
          .attr("transform", `translate(0, ${innerHeight})`)
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("fill", "white")
          .style("font-size", "9px");

        svg
          .append("g")
          .call(
            d3
              .axisLeft(y)
              .ticks(5)
              .tickFormat((d) => "£" + (d / 1000000) + "M")
          )
          .selectAll("text")
          .attr("fill", "white")
          .style("font-size", "9px");

        svg.selectAll(".tick line").attr("stroke", "rgba(255, 255, 255, 0.1)");
        svg.selectAll("path.domain").attr("stroke", "rgba(255, 255, 255, 0.3)");
      }

      // Create Trend Charts (Revenue, Wages, Profit)
      function createTrendCharts() {
        if (!historicalData || historicalData.length <= 1) {
          ["revenueTrendChart", "wagesTrendChart", "profitTrendChart"].forEach((id) => {
            d3.select(`#${id}`)
              .append("div")
              .style("text-align", "center")
              .style("padding", "40px")
              .style("color", "rgba(255, 255, 255, 0.5)")
              .text("Not enough historical data available");
          });
          return;
        }

        createTrendChart("revenueTrendChart", "total_income", "#05D4BE", "£");
        createTrendChart("wagesTrendChart", "staff_costs", "#FF9500", "£");
        createTrendChart("profitTrendChart", "operating_profit_loss", "#4CD964", "£", true);
      }

      function createTrendChart(elementId, dataKey, color, prefix, allowNegative = false) {
        const container = document.getElementById(elementId);
        const width = container.clientWidth;
        const height = container.clientHeight;
        const margin = { top: 20, right: 30, bottom: 40, left: 60 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const svg = d3
          .select(`#${elementId}`)
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .append("g")
          .attr("transform", `translate(${margin.left}, ${margin.top})`);

        const filteredData = historicalData.filter((d) => d[dataKey] !== null);

        if (filteredData.length <= 1) {
          svg
            .append("text")
            .attr("x", innerWidth / 2)
            .attr("y", innerHeight / 2)
            .attr("text-anchor", "middle")
            .attr("fill", "rgba(255, 255, 255, 0.5)")
            .text("Not enough historical data available");
          return;
        }

        const x = d3.scaleBand().domain(filteredData.map((d) => d.financial_year)).range([0, innerWidth]).padding(0.3);
        let yMin, yMax;
        if (allowNegative) {
          yMin = Math.min(0, d3.min(filteredData, (d) => d[dataKey]) * 1.1);
          yMax = Math.max(0, d3.max(filteredData, (d) => d[dataKey]) * 1.1);
        } else {
          yMin = 0;
          yMax = d3.max(filteredData, (d) => d[dataKey]) * 1.1 || 1;
        }
        const y = d3.scaleLinear().domain([yMin, yMax]).range([innerHeight, 0]);

        svg
          .selectAll(".bar")
          .data(filteredData)
          .enter()
          .append("rect")
          .attr("class", "bar")
          .attr("x", (d) => x(d.financial_year))
          .attr("y", (d) => (d[dataKey] >= 0 ? y(d[dataKey]) : y(0)))
          .attr("width", x.bandwidth())
          .attr("height", (d) => Math.abs(y(d[dataKey]) - y(0)))
          .attr("fill", (d) => (allowNegative && d[dataKey] < 0 ? "#FF3B30" : color))
          .attr("rx", 3)
          .attr("ry", 3)
          .attr("stroke", "rgba(255, 255, 255, 0.5)")
          .attr("stroke-width", 1)
          .on("mouseover", function(event, d) {
            d3.select(this).attr("stroke-width", 2);
            d3.select("#tooltip")
              .style("opacity", 1)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 15 + "px")
              .html(
                `<strong>$ {d.financial_year}</strong><br>$ {prefix}$ {(d[dataKey] / 1000000).toFixed(1)}M`
              );
          })
          .on("mouseout", function() {
            d3.select(this).attr("stroke-width", 1);
            d3.select("#tooltip").style("opacity", 0);
          });

        if (allowNegative) {
          svg
            .append("line")
            .attr("x1", 0)
            .attr("y1", y(0))
            .attr("x2", innerWidth)
            .attr("y2", y(0))
            .attr("stroke", "rgba(255, 255, 255, 0.5)")
            .attr("stroke-width", 1)
            .attr("stroke-dasharray", "5,5");
        }

        svg
          .append("g")
          .attr("transform", `translate(0, ${y(0)})`)
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("fill", "white")
          .style("font-size", "10px");

        svg
          .append("g")
          .call(
            d3
              .axisLeft(y)
              .ticks(5)
              .tickFormat((d) => `${prefix}${(d / 1000000).toFixed(0)}M`)
          )
          .selectAll("text")
          .attr("fill", "white")
          .style("font-size", "10px");

        svg.selectAll(".tick line").attr("stroke", "rgba(255, 255, 255, 0.1)");
        svg.selectAll("path.domain").attr("stroke", "rgba(255, 255, 255, 0.3)");
      }

      // Redraw charts when resizing the window
      function redrawCharts() {
        d3.selectAll("svg").remove();
        createRevenueChart();
        createTrendCharts();
      }

      document.addEventListener("DOMContentLoaded", function () {
        createRevenueChart();
        createTrendCharts();

        let resizeTimeout;
        window.addEventListener("resize", function () {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(redrawCharts, 150);
        });

        document.addEventListener("dblclick", function () {
          console.log("Club Data:", clubData);
          console.log("Historical Data:", historicalData);
          console.log("League Averages:", leagueAverages);
        });
      });
    </script>
  </body>
</html>
